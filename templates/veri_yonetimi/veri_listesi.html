{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Veri Listesi - {{ app_name|default:"DVP" }}{% endblock %}

{% block content %}
<div class="min-h-screen p-4">
    <div class="w-full">
        
        <!-- Data Table -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 w-full">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    üìã Veri Tablosu
                    <span class="text-sm font-normal text-gray-500">({{ veriler.count }} kayƒ±t)</span>
                </h2>
                
                <div class="flex gap-3">
                    <a href="{% url 'veri_yonetimi:veri_ekle' %}" 
                       class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        ‚ûï Yeni Veri Ekle
                    </a>
                    {% if user.is_superuser %}
                    <button onclick="exportToExcel()" 
                            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                        üìä Excel ƒ∞ndir
                    </button>
                    <button onclick="exportToPDF()" 
                            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                        üìÑ PDF ƒ∞ndir
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Veri Tablosu -->
            <div class="overflow-x-auto rounded-lg border border-gray-200 w-full">
                <table class="w-full bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            {% for sutun in sutunlar %}
                                {% if sutun.gorunur %}
                                    <th class="px-6 py-4 text-center text-sm font-bold text-black uppercase tracking-wider border-b border-gray-200" 
                                        style="width: {{ sutun.genislik|default:'auto' }};">
                                        {{ sutun.ad }}
                                    </th>
                                {% endif %}
                            {% endfor %}
                            <th class="px-6 py-4 text-center text-sm font-bold text-black uppercase tracking-wider border-b border-gray-200 w-32">
                                ƒ∞≈ülemler
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        {% for veri in veriler %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            {% for sutun in sutunlar %}
                                {% if sutun.gorunur %}
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                        {% if sutun.tip == 'kurulacak' %}
                                            <div class="flex items-center justify-center gap-2">
                                                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                                <span class="font-medium text-blue-700">{{ veri.kurulacak_cihaz_sayisi|default:"0" }}</span>
                                            </div>
                                        {% elif sutun.tip == 'kurulan' %}
                                            <div class="flex items-center justify-center gap-2">
                                                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                                <span class="font-medium text-green-700">{{ veri.kurulan_cihaz_sayisi|default:"0" }}</span>
                                            </div>
                                        {% elif sutun.tip == 'arizali' %}
                                            <div class="flex items-center justify-center gap-2">
                                                <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                                                <span class="font-medium text-red-700">{{ veri.arizali_cihaz_sayisi|default:"0" }}</span>
                                            </div>
                                        {% elif sutun.tip == 'tamamlanma' %}
                                            {% if veri.kurulacak_cihaz_sayisi %}
                                                {% widthratio veri.kurulan_cihaz_sayisi veri.kurulacak_cihaz_sayisi 100 as tamamlanma %}
                                                <div class="flex flex-col items-center gap-2">
                                                    <div class="w-20 bg-gray-200 rounded-full h-2">
                                                        <div class="h-2 rounded-full transition-all duration-300
                                                            {% if tamamlanma >= 80 %}bg-green-500
                                                            {% elif tamamlanma >= 60 %}bg-blue-500
                                                            {% elif tamamlanma >= 40 %}bg-yellow-500
                                                            {% else %}bg-red-500{% endif %}"
                                                             style="width: {{ tamamlanma }}%">
                                                        </div>
                                                    </div>
                                                    <span class="font-medium text-gray-700 text-xs">{{ tamamlanma }}%</span>
                                                </div>
                                            {% else %}
                                                <span class="text-gray-400">0%</span>
                                            {% endif %}
                                        {% elif sutun.tip == 'dinamik' %}
                                            {% for deger in veri.degerler.all %}
                                                {% if deger.sutun.id == sutun.id %}
                                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                                                        {{ deger.deger }}
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="font-medium text-gray-900">{{ veri.il_adi }}</span>
                                        {% endif %}
                                    </td>
                                {% endif %}
                            {% endfor %}
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-center">
                                <div class="flex justify-center gap-2">
                                    <a href="{% url 'veri_yonetimi:veri_guncelle' veri.id %}" 
                                       class="inline-flex items-center px-3 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium rounded transition-colors text-xs">
                                        ‚úèÔ∏è D√ºzenle
                                    </a>
                                    <a href="{% url 'veri_yonetimi:veri_sil' veri.id %}" 
                                       class="inline-flex items-center px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 font-medium rounded transition-colors text-xs">
                                        üóëÔ∏è Sil
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{{ sutunlar|length|add:1 }}" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center gap-3">
                                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                                        <span class="text-2xl text-gray-400">üì≠</span>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900 mb-1">Hen√ºz veri bulunmuyor</h3>
                                        <p class="text-gray-500 text-sm">ƒ∞lk veri kaydƒ±nƒ± eklemek i√ßin yukarƒ±daki butonu kullanƒ±n.</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Results Summary -->
            <div class="mt-6 p-4 bg-green-50 rounded-lg border border-green-200 text-center">
                <p class="text-green-800 font-medium text-sm">
                    üéâ Toplam {{ veriler.count }} veri kaydƒ± ba≈üarƒ±yla listeleniyor!
                </p>
            </div>
        </div>
    </div>
</div>

<script>
function exportToExcel() {
    // Excel dƒ±≈üa aktarma
    const table = document.querySelector('table');
    const ws = XLSX.utils.table_to_sheet(table);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Veri Listesi");
    
    // Excel dosyasƒ±nƒ± indir
    XLSX.writeFile(wb, "veri_listesi.xlsx");
}

function exportToPDF() {
    // PDF dƒ±≈üa aktarma
    const table = document.querySelector('table');
    const opt = {
        margin: 1,
        filename: 'veri_listesi.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
    };
    
    html2pdf().set(opt).from(table).save();
}

// Excel ve PDF k√ºt√ºphanelerini y√ºkle
document.addEventListener('DOMContentLoaded', function() {
    // Excel k√ºt√ºphanesi
    const excelScript = document.createElement('script');
    excelScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    document.head.appendChild(excelScript);
    
    // PDF k√ºt√ºphanesi
    const pdfScript = document.createElement('script');
    pdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
    document.head.appendChild(pdfScript);
});
</script>
{% endblock %}
