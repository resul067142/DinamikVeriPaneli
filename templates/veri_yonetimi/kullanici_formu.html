{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{% if kullanici %}Kullanƒ±cƒ± G√ºncelle{% else %}Yeni Kullanƒ±cƒ± Ekle{% endif %} - {{ app_name|default:"DVP" }}{% endblock %}

{% block content %}
<div class="min-h-screen p-4">
    <div class="w-full max-w-6xl mx-auto">
        
        <!-- Test Veri Butonu -->
        {% if not kullanici %}
        <div class="text-center mb-8">
            <button type="button" onclick="generateFakeUserData()" 
                    class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium text-lg">
                üé≤ Test Verisi
            </button>
        </div>
        {% endif %}
        
        <!-- Form -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
            <form method="post" class="space-y-6" novalidate>
                {% csrf_token %}
                
                <!-- Error Messages -->
                {% if form.errors %}
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-red-600">‚ö†Ô∏è</span>
                            <h3 class="text-red-800 font-medium">Form hatalarƒ± bulundu</h3>
                        </div>
                        <ul class="text-red-700 text-sm space-y-1">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>‚Ä¢ {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <!-- Ana Form Alanlarƒ± -->
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        
                        <!-- Ad -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Ad
                                <span class="text-gray-500 text-xs ml-2">(opsiyonel)</span>
                            </label>
                            <input type="text" 
                                   name="first_name" 
                                   id="id_first_name"
                                   value="{{ kullanici.first_name|default:'' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   placeholder="√ñrnek: Ahmet"
                                   maxlength="30">
                        </div>
                        
                        <!-- Soyad -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Soyad
                                <span class="text-gray-500 text-xs ml-2">(opsiyonel)</span>
                            </label>
                            <input type="text" 
                                   name="last_name" 
                                   id="id_last_name"
                                   value="{{ kullanici.last_name|default:'' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   placeholder="√ñrnek: Yƒ±lmaz"
                                   maxlength="30">
                        </div>
                        
                        <!-- Kullanƒ±cƒ± Adƒ± -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Kullanƒ±cƒ± Adƒ± 
                                <span class="text-red-500 text-xs ml-1">*</span>
                            </label>
                            <input type="text" 
                                   name="username" 
                                   id="id_username"
                                   value="{{ kullanici.username|default:'' }}"
                                   {% if kullanici %}readonly{% endif %}
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors {% if kullanici %}bg-gray-50{% endif %}"
                                   placeholder="√ñrnek: ahmet.yilmaz"
                                   pattern="[a-z0-9._-]+"
                                   title="Sadece k√º√ß√ºk harf, rakam, nokta, alt √ßizgi ve tire"
                                   maxlength="150"
                                   required>
                            <div class="text-xs text-gray-600 mt-1">
                                Benzersiz kullanƒ±cƒ± adƒ± girin
                            </div>
                        </div>
                        
                        <!-- E-posta -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                E-posta Adresi
                                <span class="text-gray-500 text-xs ml-2">(opsiyonel)</span>
                            </label>
                            <input type="email" 
                                   name="email" 
                                   id="id_email"
                                   value="{{ kullanici.email|default:'' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   placeholder="√ñrnek: ahmet.yilmaz@dvp.com"
                                   maxlength="254">
                        </div>
                        
                        <!-- TC Kimlik -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                TC Kimlik No
                                <span class="text-red-500 text-xs ml-1">*</span>
                            </label>
                            <input type="text" 
                                   name="tc_kimlik" 
                                   id="id_tc_kimlik"
                                   value="{% if kullanici.profile.tc_kimlik %}{{ kullanici.profile.tc_kimlik }}{% endif %}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   placeholder="12345678901"
                                   pattern="[0-9]{11}"
                                   maxlength="11"
                                   oninput="validateTC(this)"
                                   required>
                            <div id="tc_error" class="hidden mt-1 text-xs text-red-600"></div>
                            <div id="tc_success" class="hidden mt-1 text-xs text-green-600">‚úÖ Ge√ßerli TC Kimlik No</div>
                            <div class="text-xs text-gray-600 mt-1">
                                11 haneli TC kimlik numarasƒ±
                            </div>
                        </div>
                        
                        {% if not kullanici %}
                        <!-- ≈ûifre -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ≈ûifre
                                <span class="text-red-500 text-xs ml-1">*</span>
                            </label>
                            <input type="password" 
                                   name="password1" 
                                   id="id_password1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   placeholder="G√ºvenli bir ≈üifre girin"
                                   minlength="8"
                                   required>
                            <div class="text-xs text-gray-600 mt-1">
                                En az 8 karakter, harf ve rakam i√ßermeli
                            </div>
                        </div>
                        
                        <!-- ≈ûifre Tekrar -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ≈ûifre Tekrar
                                <span class="text-red-500 text-xs ml-1">*</span>
                            </label>
                            <input type="password" 
                                   name="password2" 
                                   id="id_password2"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                   placeholder="≈ûifrenizi tekrar girin"
                                   minlength="8"
                                   required>
                            <div class="text-xs text-gray-600 mt-1">
                                Yukarƒ±daki ≈üifre ile aynƒ± olmalƒ±
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Rol Se√ßimi -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Kullanƒ±cƒ± Rol√º
                                <span class="text-gray-500 text-xs ml-2">(opsiyonel)</span>
                            </label>
                            <select name="user_role" 
                                    id="id_user_role"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <option value="user" {% if not kullanici or not kullanici.is_staff and not kullanici.is_superuser %}selected{% endif %}>Normal Kullanƒ±cƒ±</option>
                                <option value="staff" {% if kullanici.is_staff and not kullanici.is_superuser %}selected{% endif %}>ƒ∞l Sorumlusu</option>
                                <option value="admin" {% if kullanici.is_superuser %}selected{% endif %}>Y√∂netici</option>
                            </select>
                            <div class="text-xs text-gray-600 mt-1">
                                Kullanƒ±cƒ±nƒ±n sistem i√ßindeki yetki seviyesi
                            </div>
                        </div>
                        
                        <!-- Durum -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Kullanƒ±cƒ± Durumu
                            </label>
                            <select name="is_active" 
                                    id="id_is_active"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <option value="true" {% if not kullanici or kullanici.is_active %}selected{% endif %}>Aktif</option>
                                <option value="false" {% if kullanici and not kullanici.is_active %}selected{% endif %}>Pasif</option>
                            </select>
                            <div class="text-xs text-gray-600 mt-1">
                                Pasif kullanƒ±cƒ±lar sisteme giri≈ü yapamaz
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sorumlu ƒ∞ller B√∂l√ºm√º -->
                    <div class="mt-8">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            Sorumlu ƒ∞ller 
                            <span class="text-gray-500 text-xs ml-2">(opsiyonel)</span>
                        </label>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <div class="mb-3">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="select_all_cities" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="text-sm font-medium text-blue-700">üáπüá∑ T√ºm ƒ∞lleri Se√ß / Se√ßimi Kaldƒ±r</span>
                                </label>
                            </div>
                            <hr class="mb-3 border-gray-300">
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-48 overflow-y-auto">
                                {% for il in turkiye_illeri %}
                                    <label class="flex items-center gap-2 cursor-pointer hover:bg-white p-1 rounded transition-colors">
                                        <input type="checkbox" 
                                               name="sorumlu_iller" 
                                               value="{{ il }}" 
                                               class="w-3 h-3 text-blue-600 border-gray-300 rounded city-checkbox focus:ring-blue-500"
                                               {% if kullanici.profile.sorumlu_iller and il in kullanici.profile.get_sorumlu_iller_list %}checked{% endif %}>
                                        <span class="text-xs text-gray-700">{{ il }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                            <div class="mt-3 text-xs text-gray-600">
                                ‚ÑπÔ∏è Hi√ß il se√ßilmezse kullanƒ±cƒ± t√ºm illerin verilerine eri≈üecektir.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 pt-8">
                    <button type="submit" 
                            class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium text-lg">
                        {% if kullanici %}üíæ G√ºncelle{% else %}‚ûï Kullanƒ±cƒ±yƒ± Ekle{% endif %}
                    </button>
                    <a href="{% url 'veri_yonetimi:kullanici_listesi' %}" 
                       class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium text-lg">
                        ‚ùå ƒ∞ptal
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Geli≈ümi≈ü test verisi olu≈üturma fonksiyonu
function generateFakeUserData() {
    console.log('Kullanƒ±cƒ± test verisi olu≈üturuluyor...');
    
    try {
        const fakeNames = [
            'Ahmet Yƒ±lmaz', 'Mehmet Demir', 'Fatma Kaya', 'Ali √ñzkan', 'Ay≈üe √áelik',
            'Mustafa ≈ûahin', 'Zeynep Arslan', 'Hasan Polat', 'Elif Ko√ß', 'ƒ∞brahim Kurt'
        ];
        const randomName = fakeNames[Math.floor(Math.random() * fakeNames.length)];
        const [firstName, lastName] = randomName.split(' ');
        
        // Form alanlarƒ±nƒ± doldur
        const firstNameInput = document.getElementById('id_first_name');
        const lastNameInput = document.getElementById('id_last_name');
        const usernameInput = document.getElementById('id_username');
        const emailInput = document.getElementById('id_email');
        const tcInput = document.getElementById('id_tc_kimlik');
        const password1Input = document.getElementById('id_password1');
        const password2Input = document.getElementById('id_password2');
        const roleSelect = document.getElementById('id_user_role');
        
        if (firstNameInput) firstNameInput.value = firstName;
        if (lastNameInput) lastNameInput.value = lastName;
        if (usernameInput) usernameInput.value = `${firstName.toLowerCase()}.${lastName.toLowerCase()}`;
        if (emailInput) emailInput.value = `${firstName.toLowerCase()}.${lastName.toLowerCase()}@dvp.com`;
        if (tcInput) tcInput.value = generateFakeTC();
        if (password1Input) password1Input.value = 'Test123!';
        if (password2Input) password2Input.value = 'Test123!';
        if (roleSelect) {
            const roles = ['user', 'staff', 'admin'];
            roleSelect.value = roles[Math.floor(Math.random() * roles.length)];
        }
        
        // TC validation trigger
        if (tcInput) {
            validateTC(tcInput);
        }
        
        showSuccessNotification('üé≤ Test verileri ba≈üarƒ±yla eklendi!');
        
    } catch (error) {
        console.error('Test verisi olu≈üturma hatasƒ±:', error);
        showErrorNotification('‚ö†Ô∏è Test verisi olu≈üturulurken hata olu≈ütu: ' + error.message);
    }
}

// TC Kimlik √ºretme ve validasyon fonksiyonlarƒ±
function generateFakeTC() {
    let tc = '';
    for (let i = 0; i < 9; i++) {
        tc += Math.floor(Math.random() * 10);
    }
    
    let tek = 0, cift = 0;
    for (let i = 0; i < 9; i++) {
        if (i % 2 === 0) {
            tek += parseInt(tc[i]);
        } else {
            cift += parseInt(tc[i]);
        }
    }
    
    const h10 = (tek * 7 - cift) % 10;
    const h11 = (tek + cift + h10) % 10;
    
    return tc + h10 + h11;
}

function validateTC(input) {
    const tc = input.value.replace(/\D/g, '');
    input.value = tc;
    
    if (tc.length === 11) {
        if (tc[0] === '0') {
            showTCError('TC Kimlik No 0 ile ba≈ülayamaz');
            return false;
        }
        
        let tek = 0, cift = 0;
        for (let i = 0; i < 9; i++) {
            if (i % 2 === 0) {
                tek += parseInt(tc[i]);
            } else {
                cift += parseInt(tc[i]);
            }
        }
        
        const h10 = (tek * 7 - cift) % 10;
        const h11 = (tek + cift + h10) % 10;
        
        if (parseInt(tc[9]) === h10 && parseInt(tc[10]) === h11) {
            showTCSuccess();
            return true;
        } else {
            showTCError('Ge√ßersiz TC Kimlik No');
            return false;
        }
    } else if (tc.length > 0) {
        showTCError('TC Kimlik No 11 haneli olmalƒ±dƒ±r');
        return false;
    } else {
        hideTCMessages();
        return false;
    }
}

function showTCError(message) {
    const tcError = document.getElementById('tc_error');
    const tcSuccess = document.getElementById('tc_success');
    const tcInput = document.getElementById('id_tc_kimlik');
    
    if (tcError) {
        tcError.textContent = message;
        tcError.classList.remove('hidden');
    }
    if (tcSuccess) tcSuccess.classList.add('hidden');
    if (tcInput) {
        tcInput.classList.add('border-red-500');
        tcInput.classList.remove('border-green-500');
    }
}

function showTCSuccess() {
    const tcError = document.getElementById('tc_error');
    const tcSuccess = document.getElementById('tc_success');
    const tcInput = document.getElementById('id_tc_kimlik');
    
    if (tcError) tcError.classList.add('hidden');
    if (tcSuccess) tcSuccess.classList.remove('hidden');
    if (tcInput) {
        tcInput.classList.remove('border-red-500');
        tcInput.classList.add('border-green-500');
    }
}

function hideTCMessages() {
    const tcError = document.getElementById('tc_error');
    const tcSuccess = document.getElementById('tc_success');
    const tcInput = document.getElementById('id_tc_kimlik');
    
    if (tcError) tcError.classList.add('hidden');
    if (tcSuccess) tcSuccess.classList.add('hidden');
    if (tcInput) {
        tcInput.classList.remove('border-red-500', 'border-green-500');
    }
}

// Bildirim fonksiyonlarƒ±
function showSuccessNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 transform transition-all duration-300 max-w-sm';
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="text-2xl">‚úÖ</span>
            <div>
                <div class="font-medium">${message}</div>
                <div class="text-green-100 text-sm mt-1">Formu g√∂zden ge√ßirin ve kaydedin</div>
            </div>
        </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) notification.remove();
        }, 300);
    }, 5000);
}

function showErrorNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 transform transition-all duration-300 max-w-sm';
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="text-2xl">‚ùå</span>
            <div>
                <div class="font-medium">${message}</div>
                <div class="text-red-100 text-sm mt-1">L√ºtfen tekrar deneyin</div>
            </div>
        </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) notification.remove();
        }, 300);
    }, 7000);
}

// Sayfa y√ºklendiƒüinde event listener'larƒ± ayarla
document.addEventListener('DOMContentLoaded', function() {
    console.log('Kullanƒ±cƒ± formu sayfasƒ± y√ºklendi');
    
    // T√ºm√ºn√º se√ß/kaldƒ±r i≈ülevi
    const selectAllCheckbox = document.getElementById('select_all_cities');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.city-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
        });
    }
    
    // Bireysel checkbox deƒüi≈üikliklerini izle
    document.querySelectorAll('.city-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            const allCheckboxes = document.querySelectorAll('.city-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.city-checkbox:checked');
            
            if (selectAllCheckbox) {
                if (checkedCheckboxes.length === allCheckboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else if (checkedCheckboxes.length === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }
        });
    });
});
</script>
{% endblock %}
