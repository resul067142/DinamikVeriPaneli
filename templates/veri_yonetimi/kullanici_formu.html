{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{% if kullanici %}Kullanƒ±cƒ± G√ºncelle{% else %}Kullanƒ±cƒ± Ekle{% endif %} - {{ app_name|default:"DVP" }}{% endblock %}

{% block extra_js %}
<script>
function generateFakeData() {
    const fakeNames = ['Ahmet Yƒ±lmaz', 'Mehmet Demir', 'Fatma Kaya', 'Ali √ñzkan', 'Ay≈üe √áelik'];
    const randomName = fakeNames[Math.floor(Math.random() * fakeNames.length)];
    const [firstName, lastName] = randomName.split(' ');
    
    document.querySelector('input[name="first_name"]').value = firstName;
    document.querySelector('input[name="last_name"]').value = lastName;
    document.querySelector('input[name="username"]').value = `${firstName.toLowerCase()}.${lastName.toLowerCase()}`;
    document.querySelector('input[name="email"]').value = `${firstName.toLowerCase()}.${lastName.toLowerCase()}@dvp.com`;
    document.querySelector('input[name="tc_kimlik"]').value = generateFakeTC();
    document.querySelector('input[name="password1"]').value = 'Test123!';
    document.querySelector('input[name="password2"]').value = 'Test123!';
    
    alert('üé≤ Test verileri eklendi!');
}

function generateFakeTC() {
    // TC Kimlik algoritmasƒ±na uygun fake TC √ºret
    let tc = '';
    for (let i = 0; i < 9; i++) {
        tc += Math.floor(Math.random() * 10);
    }
    
    // 10. ve 11. haneyi hesapla
    let tek = 0, cift = 0;
    for (let i = 0; i < 9; i++) {
        if (i % 2 === 0) {
            tek += parseInt(tc[i]);
        } else {
            cift += parseInt(tc[i]);
        }
    }
    
    const h10 = (tek * 7 - cift) % 10;
    const h11 = (tek + cift + h10) % 10;
    
    return tc + h10 + h11;
}

function validateTC(input) {
    const tc = input.value.replace(/\D/g, '');
    const tcError = document.getElementById('tc_error');
    const tcSuccess = document.getElementById('tc_success');
    
    // Sadece rakam giri≈üine izin ver
    input.value = tc;
    
    // TC Kimlik algoritmasƒ± kontrol√º
    if (tc.length === 11) {
        if (tc[0] === '0') {
            showTCError('TC Kimlik No 0 ile ba≈ülayamaz');
            return false;
        }
        
        let tek = 0, cift = 0;
        for (let i = 0; i < 9; i++) {
            if (i % 2 === 0) {
                tek += parseInt(tc[i]);
            } else {
                cift += parseInt(tc[i]);
            }
        }
        
        const h10 = (tek * 7 - cift) % 10;
        const h11 = (tek + cift + h10) % 10;
        
        if (parseInt(tc[9]) === h10 && parseInt(tc[10]) === h11) {
            showTCSuccess();
            return true;
        } else {
            showTCError('Ge√ßersiz TC Kimlik No');
            return false;
        }
    } else if (tc.length > 0) {
        showTCError('TC Kimlik No 11 haneli olmalƒ±dƒ±r');
        return false;
    } else {
        hideTCMessages();
        return false;
    }
}

function showTCError(message) {
    const tcError = document.getElementById('tc_error');
    const tcSuccess = document.getElementById('tc_success');
    
    tcError.textContent = message;
    tcError.classList.remove('hidden');
    tcSuccess.classList.add('hidden');
    
    document.getElementById('tc_kimlik').classList.add('border-red-500');
    document.getElementById('tc_kimlik').classList.remove('border-green-500');
}

function showTCSuccess() {
    const tcError = document.getElementById('tc_error');
    const tcSuccess = document.getElementById('tc_success');
    
    tcError.classList.add('hidden');
    tcSuccess.classList.remove('hidden');
    
    document.getElementById('tc_kimlik').classList.remove('border-red-500');
    document.getElementById('tc_kimlik').classList.add('border-green-500');
}

function hideTCMessages() {
    const tcError = document.getElementById('tc_error');
    const tcSuccess = document.getElementById('tc_success');
    
    tcError.classList.add('hidden');
    tcSuccess.classList.add('hidden');
    
    document.getElementById('tc_kimlik').classList.remove('border-red-500', 'border-green-500');
}
</script>
{% endblock %}

{% block content %}
<div class="p-6">
    <div class="max-w-4xl mx-auto">
        

        
        <!-- Test Veri Butonu -->
        {% if not kullanici %}
        <div class="text-center mb-6">
            <button type="button" onclick="generateFakeData()" 
                    class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                üé≤ Test Verisi
            </button>
        </div>
        {% endif %}
        
        <!-- Form -->
        <form method="post" class="space-y-4">
            {% csrf_token %}
            
                         <!-- Ad Soyad -->
             <div class="grid grid-cols-2 gap-4">
                 <div>
                     <label class="block text-sm font-medium text-gray-700 mb-1">Ad</label>
                     <input type="text" name="first_name" value="{{ kullanici.first_name|default:'' }}"
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                            placeholder="Ad">
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-gray-700 mb-1">Soyad</label>
                     <input type="text" name="last_name" value="{{ kullanici.last_name|default:'' }}"
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                            placeholder="Soyad">
                 </div>
             </div>
             
                         <!-- Kullanƒ±cƒ± Adƒ± ve E-posta -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Kullanƒ±cƒ± Adƒ± <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="username" value="{{ kullanici.username|default:'' }}"
                           {% if kullanici %}readonly{% endif %}
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 {% if kullanici %}bg-gray-100{% endif %}"
                           placeholder="kullanici.adi"
                           required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">E-posta</label>
                    <input type="email" name="email" value="{{ kullanici.email|default:'' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                           placeholder="kullanici@domain.com">
                </div>
            </div>
            
            <!-- TC Kimlik -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    TC Kimlik No <span class="text-red-500">*</span>
                </label>
                <input type="text" name="tc_kimlik" id="tc_kimlik" 
                       value="{% if kullanici.profile.tc_kimlik %}{{ kullanici.profile.tc_kimlik }}{% endif %}"
                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                       placeholder="12345678901"
                       pattern="[0-9]{11}"
                       maxlength="11"
                       oninput="validateTC(this)"
                       required>
                <div id="tc_error" class="hidden mt-1 text-xs text-red-600"></div>
                <div id="tc_success" class="hidden mt-1 text-xs text-green-600">‚úÖ Ge√ßerli TC Kimlik No</div>
            </div>
            
            <!-- Sorumlu ƒ∞ller -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Sorumlu ƒ∞ller <span class="text-gray-500">(ƒ∞steƒüe baƒülƒ±)</span>
                </label>
                <div class="border border-gray-300 rounded p-3 max-h-48 overflow-y-auto bg-white">
                    <div class="mb-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="select_all_cities" class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                            <span class="text-sm font-medium text-blue-600">T√ºm ƒ∞lleri Se√ß / Se√ßimi Kaldƒ±r</span>
                        </label>
                    </div>
                    <hr class="mb-2">
                    <div class="grid grid-cols-3 gap-2">
                        {% for il in turkiye_illeri %}
                            <label class="flex items-center gap-1">
                                <input type="checkbox" 
                                       name="sorumlu_iller" 
                                       value="{{ il }}" 
                                       class="w-3 h-3 text-blue-600 border-gray-300 rounded city-checkbox"
                                       {% if kullanici.profile.sorumlu_iller and il in kullanici.profile.get_sorumlu_iller_list %}checked{% endif %}>
                                <span class="text-xs">{{ il }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    ‚ÑπÔ∏è Kullanƒ±cƒ±nƒ±n sorumlu olduƒüu iller. Hi√ß se√ßilmezse t√ºm illerin verilerini g√∂rebilir.
                </p>
            </div>

            <script>
            // T√ºm√ºn√º se√ß/kaldƒ±r i≈ülevi
            document.getElementById('select_all_cities').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.city-checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
            });
            
            // Bireysel checkbox deƒüi≈üikliklerini izle
            document.querySelectorAll('.city-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    const allCheckboxes = document.querySelectorAll('.city-checkbox');
                    const checkedCheckboxes = document.querySelectorAll('.city-checkbox:checked');
                    const selectAllCheckbox = document.getElementById('select_all_cities');
                    
                    if (checkedCheckboxes.length === allCheckboxes.length) {
                        selectAllCheckbox.checked = true;
                        selectAllCheckbox.indeterminate = false;
                    } else if (checkedCheckboxes.length === 0) {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = false;
                    } else {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = true;
                    }
                });
            });
            </script>
            
            <!-- ≈ûifre (Sadece yeni kullanƒ±cƒ±lar) -->
            {% if not kullanici %}
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        ≈ûifre <span class="text-red-500">*</span>
                    </label>
                    <input type="password" name="password1" id="password1"
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                           placeholder="≈ûifre"
                           required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        ≈ûifre Tekrar <span class="text-red-500">*</span>
                    </label>
                    <input type="password" name="password2" id="password2"
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
                           placeholder="≈ûifre tekrar"
                           required>
                </div>
            </div>
            {% endif %}
            
                         <!-- Yetkiler -->
             <div class="space-y-3">
                 <label class="text-sm font-medium text-gray-700">Yetkiler</label>
                 <div class="grid grid-cols-3 gap-4">
                     <label class="flex items-center gap-2">
                         <input type="checkbox" name="is_superuser" {% if kullanici.is_superuser %}checked{% endif %}
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                         <span class="text-sm">S√ºper Kullanƒ±cƒ±</span>
                     </label>
                     <label class="flex items-center gap-2">
                         <input type="checkbox" name="is_staff" {% if kullanici.is_staff %}checked{% endif %}
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                         <span class="text-sm">ƒ∞l Sorumlusu</span>
                     </label>
                     <label class="flex items-center gap-2">
                         <input type="checkbox" name="is_active" {% if not kullanici or kullanici.is_active %}checked{% endif %}
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                         <span class="text-sm">Aktif</span>
                     </label>
                 </div>
             </div>
            
            <!-- Butonlar -->
            <div class="flex gap-3 pt-4">
                <button type="submit" class="flex-1 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                    {% if kullanici %}üíæ G√ºncelle{% else %}‚ûï Ekle{% endif %}
                </button>
                <a href="{% url 'veri_yonetimi:kullanici_listesi' %}" 
                   class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50">
                    ‚ùå ƒ∞ptal
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
