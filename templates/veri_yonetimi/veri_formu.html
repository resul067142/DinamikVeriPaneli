{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{% if veri.pk %}Veri DÃ¼zenle{% else %}Yeni Veri Ekle{% endif %} - {{ app_name|default:"DVP" }}{% endblock %}

{% block content %}
<div class="min-h-screen p-4">
    <div class="w-full max-w-6xl mx-auto">
        
        <!-- Test Veri Butonu -->
        {% if not veri %}
        <div class="text-center mb-8">
            <button type="button" onclick="generateFakeData()" 
                    class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium text-lg">
                ğŸ² Test Verisi
            </button>
        </div>
        {% endif %}
        
        <!-- Form -->
        {% if aktif_sutunlar %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
                <form method="post" class="space-y-6" novalidate>
                    {% csrf_token %}
                    
                    <!-- Error Messages -->
                    {% if form.errors %}
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-red-600">âš ï¸</span>
                                <h3 class="text-red-800 font-medium">Form hatalarÄ± bulundu</h3>
                            </div>
                            <ul class="text-red-700 text-sm space-y-1">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>â€¢ {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- Ana Form AlanlarÄ± -->
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {% for sutun in aktif_sutunlar %}
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ sutun.ad }}
                                    <span class="text-gray-500 text-xs ml-2">(opsiyonel)</span>
                                </label>
                                
                                {% if sutun.ad == 'Ä°l AdÄ±' %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="Ä°zmir, Ankara, Ä°stanbul..."
                                           maxlength="50">
                                    <div class="text-xs text-gray-600 mt-1">
                                        Åehir adÄ±nÄ± yazÄ±n
                                    </div>
                                    
                                {% elif sutun.ad == 'Plaka' %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="01, 06, 34, 35..."
                                           pattern="[0-9]{1,2}"
                                           title="Plaka kodu: 01-81 arasÄ± rakam">
                                    <div class="text-xs text-gray-600 mt-1">
                                        Sadece rakam: 01-81 arasÄ±
                                    </div>
                                    
                                {% elif 'Cihaz' in sutun.ad %}
                                    <input type="number" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="0, 5, 25, 100..."
                                           min="0"
                                           step="1">
                                    
                                {% elif 'Durum' in sutun.ad or 'Tamamlanma' in sutun.ad %}
                                    <input type="number" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-gray-50"
                                           placeholder="Otomatik hesaplanacak"
                                           min="0"
                                           max="100"
                                           step="1"
                                           readonly
                                           title="Bu alan otomatik hesaplanÄ±r">
                                    <div class="text-xs text-gray-500 mt-1">
                                        Otomatik hesaplanÄ±r
                                    </div>
                                    
                                {% elif 'Tarih' in sutun.ad %}
                                    <input type="date" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    
                                {% else %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="{{ sutun.ad }} deÄŸerini girin">
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4 pt-8">
                        <button type="submit" 
                                class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium text-lg">
                            {% if veri.pk %}ğŸ’¾ GÃ¼ncelle{% else %}â• Veriyi Ekle{% endif %}
                        </button>
                        <a href="{% url 'veri_yonetimi:veri_listesi' %}" 
                           class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium text-lg">
                            âŒ Ä°ptal
                        </a>
                    </div>
                </form>
            </div>
        {% else %}
            <!-- No Columns Available -->
            <div class="bg-white rounded-lg shadow-md border border-gray-100 p-8 text-center">
                <div class="text-6xl mb-4">âš ï¸</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">SÃ¼tun BulunamadÄ±</h3>
                <p class="text-gray-600 mb-6">
                    Veri eklemek iÃ§in Ã¶nce sÃ¼tun tanÄ±mlamalarÄ± yapÄ±lmalÄ±dÄ±r.
                </p>
                <div class="flex flex-wrap justify-center gap-3">
                    <a href="{% url 'veri_yonetimi:sutun_ekle' %}" 
                       class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        â• Ä°lk SÃ¼tunu Ekle
                    </a>
                    <a href="{% url 'veri_yonetimi:ana_sayfa' %}" 
                       class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
                        ğŸ  Ana Sayfa
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
function generateFakeData() {
    console.log('Test verisi oluÅŸturuluyor...');
    
    try {
        // TÃ¼m input alanlarÄ±nÄ± kontrol et
        const allInputs = document.querySelectorAll('input[name^="sutun_"]');
        console.log('Toplam input alanÄ± sayÄ±sÄ±:', allInputs.length);
        
        if (allInputs.length === 0) {
            throw new Error('Form alanlarÄ± bulunamadÄ±');
        }
        
        let fieldsSet = 0;
        
        // Ä°l AdÄ± (sutun_25) - SÄ±ra 1
        const ilInput = document.querySelector('input[name="sutun_25"]');
        if (ilInput) {
            const iller = ['Adana', 'AdÄ±yaman', 'Afyonkarahisar', 'AÄŸrÄ±', 'Amasya', 'Ankara', 'Antalya', 'Artvin', 'AydÄ±n', 'BalÄ±kesir', 'Bilecik', 'BingÃ¶l', 'Bitlis', 'Bolu', 'Burdur', 'Bursa', 'Ã‡anakkale', 'Ã‡ankÄ±rÄ±', 'Ã‡orum', 'Denizli', 'DiyarbakÄ±r', 'Edirne', 'ElazÄ±ÄŸ', 'Erzincan', 'Erzurum', 'EskiÅŸehir', 'Gaziantep', 'Giresun', 'GÃ¼mÃ¼ÅŸhane', 'HakkÃ¢ri', 'Hatay', 'Isparta', 'Mersin', 'Ä°stanbul', 'Ä°zmir', 'Kars', 'Kastamonu', 'Kayseri', 'KÄ±rklareli', 'KÄ±rÅŸehir', 'Kocaeli', 'Konya', 'KÃ¼tahya', 'Malatya', 'Manisa', 'KahramanmaraÅŸ', 'Mardin', 'MuÄŸla', 'MuÅŸ', 'NevÅŸehir', 'NiÄŸde', 'Ordu', 'Rize', 'Sakarya', 'Samsun', 'Siirt', 'Sinop', 'Sivas', 'TekirdaÄŸ', 'Tokat', 'Trabzon', 'Tunceli', 'ÅanlÄ±urfa', 'UÅŸak', 'Van', 'Yozgat', 'Zonguldak', 'Aksaray', 'Bayburt', 'Karaman', 'KÄ±rÄ±kkale', 'Batman', 'ÅÄ±rnak', 'BartÄ±n', 'Ardahan', 'IÄŸdÄ±r', 'Yalova', 'KarabÃ¼k', 'Kilis', 'Osmaniye', 'DÃ¼zce'];
            const randomIl = iller[Math.floor(Math.random() * iller.length)];
            ilInput.value = randomIl;
            console.log('âœ… Ä°l adÄ± set edildi:', randomIl);
            fieldsSet++;
        } else {
            console.log('âš ï¸ Ä°l AdÄ± alanÄ± bulunamadÄ±');
        }
        
        // Plaka (sutun_24) - SÄ±ra 2
        const plakaInput = document.querySelector('input[name="sutun_24"]');
        if (plakaInput) {
            const randomPlaka = Math.floor(Math.random() * 81) + 1;
            const formattedPlaka = randomPlaka.toString().padStart(2, '0');
            plakaInput.value = formattedPlaka;
            console.log('âœ… Plaka set edildi:', formattedPlaka);
            fieldsSet++;
        } else {
            console.log('âš ï¸ Plaka alanÄ± bulunamadÄ±');
        }
        
        // Kurulacak Cihaz SayÄ±sÄ± (sutun_26) - SÄ±ra 3
        const kurulacakInput = document.querySelector('input[name="sutun_26"]');
        let randomKurulacak = 50;
        if (kurulacakInput) {
            randomKurulacak = Math.floor(Math.random() * 500) + 50; // 50-550 arasÄ±
            kurulacakInput.value = randomKurulacak;
            console.log('âœ… Kurulacak cihaz sayÄ±sÄ± set edildi:', randomKurulacak);
            fieldsSet++;
        } else {
            console.log('âš ï¸ Kurulacak cihaz alanÄ± bulunamadÄ±');
        }
        
        // Kurulan Cihaz SayÄ±sÄ± (sutun_27) - SÄ±ra 4
        const kurulanInput = document.querySelector('input[name="sutun_27"]');
        let randomKurulan = 0;
        if (kurulanInput) {
            randomKurulan = Math.floor(Math.random() * (randomKurulacak * 0.9)); // %90'Ä±na kadar
            kurulanInput.value = randomKurulan;
            console.log('âœ… Kurulan cihaz sayÄ±sÄ± set edildi:', randomKurulan);
            fieldsSet++;
        } else {
            console.log('âš ï¸ Kurulan cihaz alanÄ± bulunamadÄ±');
        }
        
        // ArÄ±zalÄ± Cihaz SayÄ±sÄ± (sutun_28) - SÄ±ra 5
        const arizaliInput = document.querySelector('input[name="sutun_28"]');
        if (arizaliInput) {
            const maxArizali = Math.floor(randomKurulan * 0.1); // KurulanlarÄ±n %10'u kadar
            const randomArizali = Math.floor(Math.random() * (maxArizali + 1));
            arizaliInput.value = randomArizali;
            console.log('âœ… ArÄ±zalÄ± cihaz sayÄ±sÄ± set edildi:', randomArizali);
            fieldsSet++;
        } else {
            console.log('âš ï¸ ArÄ±zalÄ± cihaz alanÄ± bulunamadÄ±');
        }
        
        // Tamamlanma hesaplama
        calculateCompletion();
        
        // DiÄŸer alanlarÄ± da doldur (varsa)
        fillOtherFields();
        
        // SonuÃ§ kontrolÃ¼
        if (fieldsSet === 0) {
            throw new Error('HiÃ§bir alan doldurulmadÄ±. Form yapÄ±sÄ± deÄŸiÅŸmiÅŸ olabilir.');
        }
        
        // BaÅŸarÄ± mesajÄ±
        showSuccessNotification(`Test verileri baÅŸarÄ±yla eklendi! (${fieldsSet} alan dolduruldu)`);
        
        // Form alanlarÄ±na odaklan
        if (ilInput) {
            ilInput.focus();
            ilInput.blur();
        }
        
    } catch (error) {
        console.error('Test verisi oluÅŸturma hatasÄ±:', error);
        showErrorNotification('âš ï¸ Test verisi oluÅŸturulurken hata oluÅŸtu: ' + error.message);
    }
}

// DiÄŸer alanlarÄ± doldurma fonksiyonu
function fillOtherFields() {
    // Tarih alanlarÄ±
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        const today = new Date();
        const randomDays = Math.floor(Math.random() * 365); // Son 1 yÄ±l iÃ§inde
        const randomDate = new Date(today.getTime() - (randomDays * 24 * 60 * 60 * 1000));
        input.value = randomDate.toISOString().split('T')[0];
    });
    
    // DiÄŸer text alanlarÄ±
    const textInputs = document.querySelectorAll('input[type="text"]:not([name="sutun_25"]):not([name="sutun_24"])');
    const sampleTexts = ['Proje A', 'GÃ¶rev B', 'AÃ§Ä±klama C', 'Test D', 'Durum E'];
    textInputs.forEach(input => {
        if (!input.value && !input.readOnly) {
            const randomText = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
            input.value = randomText;
        }
    });
}

// BaÅŸarÄ± bildirimi fonksiyonu
function showSuccessNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 transform transition-all duration-300 max-w-sm';
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="text-2xl">âœ…</span>
            <div>
                <div class="font-medium">${message}</div>
                <div class="text-green-100 text-sm mt-1">Formu gÃ¶zden geÃ§irin ve kaydedin</div>
            </div>
        </div>
    `;
    document.body.appendChild(notification);
    
    // 5 saniye sonra kaldÄ±r
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 5000);
}

// Hata bildirimi fonksiyonu
function showErrorNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 transform transition-all duration-300 max-w-sm';
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="text-2xl">âŒ</span>
            <div>
                <div class="font-medium">${message}</div>
                <div class="text-red-100 text-sm mt-1">LÃ¼tfen sayfayÄ± yenileyin</div>
            </div>
        </div>
    `;
    document.body.appendChild(notification);
    
    // 7 saniye sonra kaldÄ±r
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 7000);
}

// Sayfa yÃ¼klendiÄŸinde setup
document.addEventListener('DOMContentLoaded', function() {
    console.log('Veri formu sayfasÄ± yÃ¼klendi');
    
    // Test butonu kontrolÃ¼
    const testButton = document.querySelector('button[onclick="generateFakeData()"]');
    if (testButton) {
        console.log('âœ… Test verisi butonu bulundu');
    } else {
        console.log('âš ï¸ Test verisi butonu bulunamadÄ±');
    }
    
    // Form alanÄ± kontrolÃ¼
    const formInputs = document.querySelectorAll('input[name^="sutun_"]');
    console.log(`ğŸ“ Toplam form alanÄ±: ${formInputs.length}`);
    
    // Form submit kontrolÃ¼
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Temel validasyon kontrolÃ¼
            const plakaInput = document.querySelector('input[name="sutun_24"]');
            const ilAdiInput = document.querySelector('input[name="sutun_25"]');
            
            if (plakaInput && ilAdiInput) {
                const plakaValue = plakaInput.value.trim();
                const ilAdiValue = ilAdiInput.value.trim();
                
                // Plaka alanÄ±na ÅŸehir ismi yazÄ±lmÄ±ÅŸ mÄ±?
                if (plakaValue && isNaN(plakaValue)) {
                    e.preventDefault();
                    showErrorNotification('Plaka alanÄ±na sadece rakam girebilirsiniz (01-81)');
                    plakaInput.focus();
                    return false;
                }
                
                // Ä°l AdÄ± alanÄ±na rakam yazÄ±lmÄ±ÅŸ mÄ±?
                if (ilAdiValue && !isNaN(ilAdiValue)) {
                    e.preventDefault();
                    showErrorNotification('Ä°l AdÄ± alanÄ±na ÅŸehir ismi yazÄ±n');
                    ilAdiInput.focus();
                    return false;
                }
                
                // Plaka aralÄ±k kontrolÃ¼
                if (plakaValue && !isNaN(plakaValue)) {
                    const plakaNum = parseInt(plakaValue);
                    if (plakaNum < 1 || plakaNum > 81) {
                        e.preventDefault();
                        showErrorNotification('Plaka kodu 01-81 arasÄ±nda olmalÄ±dÄ±r');
                        plakaInput.focus();
                        return false;
                    }
                }
            }
            
            // BaÅŸarÄ±lÄ± form gÃ¶nderimi iÃ§in bildirim
            console.log('ğŸ“ Form gÃ¶nderiliyor...');
        });
    }
    
    // Cihaz sayÄ±sÄ± hesaplama
    setupAutoCalculation();
    
    // Test butonuna tÄ±klama olaylarÄ±nÄ± dinle
    setupTestButtonEvents();
});

// Test butonu event setup
function setupTestButtonEvents() {
    const testButton = document.querySelector('button[onclick="generateFakeData()"]');
    if (testButton) {
        // Ek event listener ekle (onclick dÄ±ÅŸÄ±nda)
        testButton.addEventListener('click', function(e) {
            console.log('ğŸ² Test butonu tÄ±klandÄ±');
            // onclick fonksiyonu zaten Ã§alÄ±ÅŸacak, burada sadece log yapÄ±yoruz
        });
        
        // Hover efekti ekle
        testButton.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
        });
        
        testButton.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    }
}

// Otomatik hesaplama iÃ§in basit function
function setupAutoCalculation() {
    const cihazInputs = document.querySelectorAll('input[type="number"]');
    
    cihazInputs.forEach(input => {
        if (input.placeholder && input.placeholder.includes('0, 5, 25, 100')) {
            input.addEventListener('input', calculateCompletion);
        }
    });
}

// Basit tamamlanma hesaplama
function calculateCompletion() {
    try {
        const kurulacakInput = document.querySelector('input[name="sutun_26"]');
        const kurulanInput = document.querySelector('input[name="sutun_27"]');
        const tamamlanmaInputs = document.querySelectorAll('input[placeholder="Otomatik hesaplanacak"]');
        
        if (kurulacakInput && kurulanInput && tamamlanmaInputs.length > 0) {
            const kurulacak = parseInt(kurulacakInput.value) || 0;
            const kurulan = parseInt(kurulanInput.value) || 0;
            
            let yuzde = 0;
            if (kurulacak > 0) {
                yuzde = (kurulan / kurulacak) * 100;
                yuzde = Math.round(yuzde * 1000) / 1000; // 3 ondalÄ±k basamak
                yuzde = Math.min(100, Math.max(0, yuzde)); // 0-100 arasÄ±nda sÄ±nÄ±rla
            }
            
            // TÃ¼m tamamlanma alanlarÄ±nÄ± gÃ¼ncelle
            tamamlanmaInputs.forEach(input => {
                input.value = yuzde;
            });
            
            console.log(`âœ… Tamamlanma yÃ¼zdesi hesaplandÄ±: ${yuzde}% (${kurulan}/${kurulacak})`);
        }
    } catch (error) {
        console.error('Hesaplama hatasÄ±:', error);
    }
}

// Form deÄŸerlerini yÃ¼kle (dÃ¼zenleme modunda)
{% if is_edit and field_values_json %}
document.addEventListener('DOMContentLoaded', function() {
    const fieldValues = {{ field_values_json|safe }};
    console.log('Form deÄŸerleri yÃ¼kleniyor:', fieldValues);
    
    // Her field iÃ§in deÄŸeri set et
    for (const [fieldName, value] of Object.entries(fieldValues)) {
        const input = document.querySelector(`input[name="${fieldName}"], select[name="${fieldName}"]`);
        if (input && value !== null && value !== '') {
            input.value = value;
            console.log(`âœ… ${fieldName} = ${value}`);
        }
    }
    
    // Ä°l AdÄ± dropdown'larÄ± iÃ§in Ã¶zel iÅŸlem
    {% for sutun in aktif_sutunlar %}
        {% if sutun.ad == 'Ä°l AdÄ±' %}
            const ilSelect = document.querySelector('select[name="sutun_{{ sutun.id }}"]');
            if (ilSelect && fieldValues['sutun_{{ sutun.id }}']) {
                ilSelect.value = fieldValues['sutun_{{ sutun.id }}'];
            }
        {% endif %}
    {% endfor %}
});
{% endif %}
</script>
{% endblock %}
