{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{% if veri.pk %}Veri Düzenle{% else %}Yeni Veri Ekle{% endif %} - {{ app_name|default:"DVP" }}{% endblock %}

{% block content %}
<div class="min-h-screen p-4">
    <div class="w-full max-w-6xl mx-auto">
        
        <!-- Test Veri Butonu -->
        {% if not veri %}
        <div class="text-center mb-8">
            <button type="button" onclick="generateFakeData()" 
                    class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium text-lg">
                🎲 Test Verisi
            </button>
        </div>
        {% endif %}
        
        <!-- Form -->
        {% if aktif_sutunlar %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
                <form method="post" class="space-y-6" novalidate>
                    {% csrf_token %}
                    
                    <!-- Error Messages -->
                    {% if form.errors %}
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-red-600">⚠️</span>
                                <h3 class="text-red-800 font-medium">Form hataları bulundu</h3>
                            </div>
                            <ul class="text-red-700 text-sm space-y-1">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>• {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- Form Fields Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for sutun in aktif_sutunlar %}
                            <div class="{% if sutun.ad == 'Plaka' or sutun.ad == 'İl Adı' %}md:col-span-2{% endif %}">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    {% if sutun.ad == 'Plaka' %}
                                        🚗 {{ sutun.ad }}
                                        <span class="text-red-500 ml-1">*</span>
                                    {% elif sutun.ad == 'İl Adı' %}
                                        🏙️ {{ sutun.ad }}
                                        <span class="text-red-500 ml-1">*</span>
                                    {% elif 'Cihaz' in sutun.ad %}
                                        📱 {{ sutun.ad }}
                                    {% elif 'Tarih' in sutun.ad %}
                                        📅 {{ sutun.ad }}
                                    {% elif 'Durum' in sutun.ad %}
                                        🔍 {{ sutun.ad }}
                                    {% else %}
                                        📝 {{ sutun.ad }}
                                    {% endif %}
                                </label>
                                
                                <!-- Input Fields -->
                                {% if sutun.ad == 'Plaka' %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="Plaka numarası girin (sınır yok)"
                                           title="Plaka numarası girin">
                                    
                                {% elif sutun.ad == 'İl Adı' %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="Adana, Ankara, İstanbul..."
                                           maxlength="50">
                                    
                                {% elif 'Cihaz' in sutun.ad %}
                                    <input type="number" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="0, 5, 25, 100..."
                                           min="0"
                                           step="1">
                                    
                                {% elif 'Durum' in sutun.ad or 'Tamamlanma' in sutun.ad %}
                                    <input type="number" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-gray-100"
                                           placeholder="Otomatik hesaplanacak"
                                           min="0"
                                           max="100"
                                           step="1"
                                           readonly
                                           title="Bu alan otomatik hesaplanır">
                                    <div class="text-xs text-gray-500 mt-1">
                                        💡 Kurulan / Kurulacak oranına göre otomatik hesaplanır
                                    </div>
                                    
                                {% elif 'Tarih' in sutun.ad %}
                                    <input type="date" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    
                                {% else %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="{{ sutun.ad }} değerini girin">
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4 pt-8">
                        <button type="submit" 
                                class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium text-lg">
                            {% if veri.pk %}💾 Güncelle{% else %}➕ Veriyi Ekle{% endif %}
                        </button>
                        <a href="{% url 'veri_yonetimi:veri_listesi' %}" 
                           class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium text-lg">
                            ❌ İptal
                        </a>
                    </div>
                </form>
            </div>
        {% else %}
            <!-- No Columns Available -->
            <div class="bg-white rounded-lg shadow-md border border-gray-100 p-8 text-center">
                <div class="text-6xl mb-4">⚠️</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Sütun Bulunamadı</h3>
                <p class="text-gray-600 mb-6">
                    Veri eklemek için önce sütun tanımlamaları yapılmalıdır.
                </p>
                <div class="flex flex-wrap justify-center gap-3">
                    <a href="{% url 'veri_yonetimi:sutun_ekle' %}" 
                       class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        ➕ İlk Sütunu Ekle
                    </a>
                    <a href="{% url 'veri_yonetimi:ana_sayfa' %}" 
                       class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
                        🏠 Ana Sayfa
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
function generateFakeData() {
    console.log('🎲 Test verisi oluşturuluyor...');
    
    try {
        // Plaka (sutun_23)
        const plakaInput = document.querySelector('input[name="sutun_23"]');
        if (plakaInput) {
            const randomPlaka = Math.floor(Math.random() * 999) + 1;
            plakaInput.value = randomPlaka.toString();
            console.log('🚗 Plaka set edildi:', plakaInput.value);
        }
        
        // İl Adı (sutun_24)
        const iller = ['Adana', 'Ankara', 'İstanbul', 'İzmir', 'Bursa', 'Antalya'];
        const ilInput = document.querySelector('input[name="sutun_24"]');
        if (ilInput) {
            const randomIl = iller[Math.floor(Math.random() * iller.length)];
            ilInput.value = randomIl;
            console.log('🏙️ İl adı set edildi:', ilInput.value);
        }
        
        // Kurulacak Cihaz Sayısı (sutun_25)
        const randomKurulacak = Math.floor(Math.random() * 100) + 10;
        const kurulacakInput = document.querySelector('input[name="sutun_25"]');
        if (kurulacakInput) {
            kurulacakInput.value = randomKurulacak;
            console.log('📱 Kurulacak cihaz sayısı set edildi:', randomKurulacak);
        }
        
        // Kurulan Cihaz Sayısı (sutun_26)
        const randomKurulan = Math.floor(Math.random() * randomKurulacak);
        const kurulanInput = document.querySelector('input[name="sutun_26"]');
        if (kurulanInput) {
            kurulanInput.value = randomKurulan;
            console.log('📱 Kurulan cihaz sayısı set edildi:', randomKurulan);
        }
        
        // Arızalı Cihaz Sayısı (sutun_27)
        const randomArizali = Math.floor(Math.random() * 20);
        const arizaliInput = document.querySelector('input[name="sutun_27"]');
        if (arizaliInput) {
            arizaliInput.value = randomArizali;
            console.log('📱 Arızalı cihaz sayısı set edildi:', randomArizali);
        }
        
        // Tamamlanma Durumu (sutun_28) - readonly olduğu için otomatik hesaplanır
        const tamamlanmaInput = document.querySelector('input[name="sutun_28"]');
        if (tamamlanmaInput) {
            const tamamlanmaYuzdesi = Math.round((randomKurulan / randomKurulacak) * 100);
            tamamlanmaInput.value = tamamlanmaYuzdesi;
            console.log('🔍 Tamamlanma yüzdesi set edildi:', tamamlanmaYuzdesi);
        }
        
        // Diğer dinamik sütunlar (sutun_32, sutun_33, sutun_35)
        const dinamikInputs = ['sutun_32', 'sutun_33', 'sutun_35'];
        dinamikInputs.forEach(inputName => {
            const input = document.querySelector(`input[name="${inputName}"]`);
            if (input) {
                const randomText = `Test_${Math.floor(Math.random() * 1000)}`;
                input.value = randomText;
                console.log(`📝 ${inputName} değeri set edildi: ${randomText}`);
            }
        });
        
        // Başarı mesajı
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        notification.innerHTML = '🎲 Test verileri başarıyla eklendi!';
        document.body.appendChild(notification);
        
        // 3 saniye sonra kaldır
        setTimeout(() => {
            notification.remove();
        }, 3000);
        
        console.log('✅ Test verisi oluşturma tamamlandı');
        
    } catch (error) {
        console.error('❌ Test verisi oluşturulurken hata:', error);
        alert('Test verisi oluşturulurken hata oluştu: ' + error.message);
    }
}

// Sayfa yüklendiğinde debug bilgileri
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 Veri formu sayfası yüklendi');
    
    // Mevcut input alanlarını kontrol et
    const inputs = document.querySelectorAll('input[name*="sutun_"]');
    console.log('🔍 Bulunan input alanları:', inputs.length);
    
    inputs.forEach((input, index) => {
        console.log(`Input ${index + 1}:`, input.name, input.placeholder);
    });
    
    // Form submit olayını yakala
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('📤 Form submit ediliyor...');
            
            // Tüm form değerlerini kontrol et
            const formData = new FormData(form);
            console.log('📋 Form verileri:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: "${value}"`);
            }
            
            // Boş alanları kontrol et
            const emptyFields = [];
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    emptyFields.push(input.name);
                }
            });
            
            if (emptyFields.length > 0) {
                console.log('⚠️ Boş alanlar:', emptyFields);
            } else {
                console.log('✅ Tüm alanlar dolu');
            }
        });
    }
    
    // Cihaz sayısı input'larına event listener ekle
    setupAutoCalculation();
});

// Otomatik hesaplama için event listener'ları ayarla
function setupAutoCalculation() {
    const cihazInputs = document.querySelectorAll('input[type="number"]');
    
    cihazInputs.forEach(input => {
        if (input.placeholder && (input.placeholder.includes('0, 5, 25, 100') || input.placeholder.includes('Kurulacak') || input.placeholder.includes('Kurulan') || input.placeholder.includes('Arızalı'))) {
            input.addEventListener('input', calculateCompletion);
            input.addEventListener('change', calculateCompletion);
            console.log('🔗 Event listener eklendi:', input.name);
        }
    });
}

// Tamamlanma durumunu otomatik hesapla
function calculateCompletion() {
    console.log('🧮 Tamamlanma durumu hesaplanıyor...');
    
    try {
        // Kurulacak cihaz sayısını bul
        let kurulacakInput = null;
        const kurulacakInputs = document.querySelectorAll('input[type="number"]');
        
        kurulacakInputs.forEach(input => {
            if (input.placeholder && input.placeholder.includes('0, 5, 25, 100')) {
                kurulacakInput = input;
            }
        });
        
        // Kurulan cihaz sayısını bul
        let kurulanInput = null;
        kurulacakInputs.forEach(input => {
            if (input.placeholder && input.placeholder.includes('0, 5, 25, 100') && input !== kurulacakInput) {
                kurulanInput = input;
            }
        });
        
        // Tamamlanma durumu input'unu bul
        const tamamlanmaInput = document.querySelector('input[placeholder="Otomatik hesaplanacak"]');
        
        if (kurulacakInput && kurulanInput && tamamlanmaInput) {
            const kurulacak = parseInt(kurulacakInput.value) || 0;
            const kurulan = parseInt(kurulanInput.value) || 0;
            
            console.log('📊 Kurulacak:', kurulacak, 'Kurulan:', kurulan);
            
            if (kurulacak > 0) {
                const tamamlanmaYuzdesi = Math.round((kurulan / kurulacak) * 100);
                tamamlanmaInput.value = tamamlanmaYuzdesi;
                console.log('✅ Tamamlanma yüzdesi hesaplandı:', tamamlanmaYuzdesi);
                
                // Renk kodlaması ekle
                if (tamamlanmaYuzdesi >= 80) {
                    tamamlanmaInput.style.backgroundColor = '#dcfce7'; // Yeşil
                    tamamlanmaInput.style.borderColor = '#16a34a';
                } else if (tamamlanmaYuzdesi >= 60) {
                    tamamlanmaInput.style.backgroundColor = '#fef3c7'; // Sarı
                    tamamlanmaInput.style.borderColor = '#d97706';
                } else if (tamamlanmaYuzdesi >= 40) {
                    tamamlanmaInput.style.backgroundColor = '#fed7aa'; // Turuncu
                    tamamlanmaInput.style.borderColor = '#ea580c';
                } else {
                    tamamlanmaInput.style.backgroundColor = '#fecaca'; // Kırmızı
                    tamamlanmaInput.style.borderColor = '#dc2626';
                }
            } else {
                tamamlanmaInput.value = 0;
                tamamlanmaInput.style.backgroundColor = '#f3f4f6'; // Gri
                tamamlanmaInput.style.borderColor = '#d1d5db';
            }
        }
        
    } catch (error) {
        console.error('❌ Hesaplama hatası:', error);
    }
}

// Form değerlerini yükle (düzenleme modunda)
{% if is_edit and field_values_json %}
document.addEventListener('DOMContentLoaded', function() {
    const fieldValues = {{ field_values_json|safe }};
    console.log('Form değerleri yükleniyor:', fieldValues);
    
    // Her field için değeri set et
    for (const [fieldName, value] of Object.entries(fieldValues)) {
        const input = document.querySelector(`input[name="${fieldName}"], select[name="${fieldName}"]`);
        if (input && value !== null && value !== '') {
            input.value = value;
            console.log(`✅ ${fieldName} = ${value}`);
        }
    }
    
    // İl Adı dropdown'ları için özel işlem
    {% for sutun in aktif_sutunlar %}
        {% if sutun.ad == 'İl Adı' %}
            const ilSelect = document.querySelector('select[name="sutun_{{ sutun.id }}"]');
            if (ilSelect && fieldValues['sutun_{{ sutun.id }}']) {
                ilSelect.value = fieldValues['sutun_{{ sutun.id }}'];
            }
        {% endif %}
    {% endfor %}
});
{% endif %}
</script>
{% endblock %}
