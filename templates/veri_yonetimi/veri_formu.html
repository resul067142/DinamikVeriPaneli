{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{% if veri.pk %}Veri Düzenle{% else %}Yeni Veri Ekle{% endif %} - {{ app_name|default:"DVP" }}{% endblock %}

{% block content %}
<div class="min-h-screen p-4">
    <div class="w-full max-w-6xl mx-auto">
        
        <!-- Test Veri Butonu -->
        {% if not veri %}
        <div class="text-center mb-8">
            <button type="button" onclick="generateFakeData()" 
                    class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium text-lg">
                🎲 Test Verisi
            </button>
        </div>
        {% endif %}
        
        <!-- Form -->
        {% if aktif_sutunlar %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
                <form method="post" class="space-y-6" novalidate>
                    {% csrf_token %}
                    
                    <!-- Error Messages -->
                    {% if form.errors %}
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-red-600">⚠️</span>
                                <h3 class="text-red-800 font-medium">Form hataları bulundu</h3>
                            </div>
                            <ul class="text-red-700 text-sm space-y-1">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>• {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- Ana Form Alanları -->
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {% for sutun in aktif_sutunlar %}
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ sutun.ad }}
                                    <span class="text-gray-500 text-xs ml-2">(opsiyonel)</span>
                                </label>
                                
                                {% if sutun.ad == 'İl Adı' %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="İzmir, Ankara, İstanbul..."
                                           maxlength="50">
                                    <div class="text-xs text-gray-600 mt-1">
                                        Şehir adını yazın
                                    </div>
                                    
                                {% elif sutun.ad == 'Plaka' %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="01, 06, 34, 35..."
                                           pattern="[0-9]{1,2}"
                                           title="Plaka kodu: 01-81 arası rakam">
                                    <div class="text-xs text-gray-600 mt-1">
                                        Sadece rakam: 01-81 arası
                                    </div>
                                    
                                {% elif 'Cihaz' in sutun.ad %}
                                    <input type="number" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="0, 5, 25, 100..."
                                           min="0"
                                           step="1">
                                    
                                {% elif 'Durum' in sutun.ad or 'Tamamlanma' in sutun.ad %}
                                    <input type="number" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-gray-50"
                                           placeholder="Otomatik hesaplanacak"
                                           min="0"
                                           max="100"
                                           step="1"
                                           readonly
                                           title="Bu alan otomatik hesaplanır">
                                    <div class="text-xs text-gray-500 mt-1">
                                        Otomatik hesaplanır
                                    </div>
                                    
                                {% elif 'Tarih' in sutun.ad %}
                                    <input type="date" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    
                                {% else %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="{{ sutun.ad }} değerini girin">
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4 pt-8">
                        <button type="submit" 
                                class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium text-lg">
                            {% if veri.pk %}💾 Güncelle{% else %}➕ Veriyi Ekle{% endif %}
                        </button>
                        <a href="{% url 'veri_yonetimi:veri_listesi' %}" 
                           class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium text-lg">
                            ❌ İptal
                        </a>
                    </div>
                </form>
            </div>
        {% else %}
            <!-- No Columns Available -->
            <div class="bg-white rounded-lg shadow-md border border-gray-100 p-8 text-center">
                <div class="text-6xl mb-4">⚠️</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Sütun Bulunamadı</h3>
                <p class="text-gray-600 mb-6">
                    Veri eklemek için önce sütun tanımlamaları yapılmalıdır.
                </p>
                <div class="flex flex-wrap justify-center gap-3">
                    <a href="{% url 'veri_yonetimi:sutun_ekle' %}" 
                       class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        ➕ İlk Sütunu Ekle
                    </a>
                    <a href="{% url 'veri_yonetimi:ana_sayfa' %}" 
                       class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
                        🏠 Ana Sayfa
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
function generateFakeData() {
    console.log('Test verisi oluşturuluyor...');
    
    try {
        // Tüm input alanlarını kontrol et
        const allInputs = document.querySelectorAll('input[name^="sutun_"]');
        console.log('Toplam input alanı sayısı:', allInputs.length);
        
        if (allInputs.length === 0) {
            throw new Error('Form alanları bulunamadı');
        }
        
        let fieldsSet = 0;
        
        // İl Adı (sutun_25) - Sıra 1
        const ilInput = document.querySelector('input[name="sutun_25"]');
        if (ilInput) {
            const iller = ['Adana', 'Adıyaman', 'Afyonkarahisar', 'Ağrı', 'Amasya', 'Ankara', 'Antalya', 'Artvin', 'Aydın', 'Balıkesir', 'Bilecik', 'Bingöl', 'Bitlis', 'Bolu', 'Burdur', 'Bursa', 'Çanakkale', 'Çankırı', 'Çorum', 'Denizli', 'Diyarbakır', 'Edirne', 'Elazığ', 'Erzincan', 'Erzurum', 'Eskişehir', 'Gaziantep', 'Giresun', 'Gümüşhane', 'Hakkâri', 'Hatay', 'Isparta', 'Mersin', 'İstanbul', 'İzmir', 'Kars', 'Kastamonu', 'Kayseri', 'Kırklareli', 'Kırşehir', 'Kocaeli', 'Konya', 'Kütahya', 'Malatya', 'Manisa', 'Kahramanmaraş', 'Mardin', 'Muğla', 'Muş', 'Nevşehir', 'Niğde', 'Ordu', 'Rize', 'Sakarya', 'Samsun', 'Siirt', 'Sinop', 'Sivas', 'Tekirdağ', 'Tokat', 'Trabzon', 'Tunceli', 'Şanlıurfa', 'Uşak', 'Van', 'Yozgat', 'Zonguldak', 'Aksaray', 'Bayburt', 'Karaman', 'Kırıkkale', 'Batman', 'Şırnak', 'Bartın', 'Ardahan', 'Iğdır', 'Yalova', 'Karabük', 'Kilis', 'Osmaniye', 'Düzce'];
            const randomIl = iller[Math.floor(Math.random() * iller.length)];
            ilInput.value = randomIl;
            console.log('✅ İl adı set edildi:', randomIl);
            fieldsSet++;
        } else {
            console.log('⚠️ İl Adı alanı bulunamadı');
        }
        
        // Plaka (sutun_24) - Sıra 2
        const plakaInput = document.querySelector('input[name="sutun_24"]');
        if (plakaInput) {
            const randomPlaka = Math.floor(Math.random() * 81) + 1;
            const formattedPlaka = randomPlaka.toString().padStart(2, '0');
            plakaInput.value = formattedPlaka;
            console.log('✅ Plaka set edildi:', formattedPlaka);
            fieldsSet++;
        } else {
            console.log('⚠️ Plaka alanı bulunamadı');
        }
        
        // Kurulacak Cihaz Sayısı (sutun_26) - Sıra 3
        const kurulacakInput = document.querySelector('input[name="sutun_26"]');
        let randomKurulacak = 50;
        if (kurulacakInput) {
            randomKurulacak = Math.floor(Math.random() * 500) + 50; // 50-550 arası
            kurulacakInput.value = randomKurulacak;
            console.log('✅ Kurulacak cihaz sayısı set edildi:', randomKurulacak);
            fieldsSet++;
        } else {
            console.log('⚠️ Kurulacak cihaz alanı bulunamadı');
        }
        
        // Kurulan Cihaz Sayısı (sutun_27) - Sıra 4
        const kurulanInput = document.querySelector('input[name="sutun_27"]');
        let randomKurulan = 0;
        if (kurulanInput) {
            randomKurulan = Math.floor(Math.random() * (randomKurulacak * 0.9)); // %90'ına kadar
            kurulanInput.value = randomKurulan;
            console.log('✅ Kurulan cihaz sayısı set edildi:', randomKurulan);
            fieldsSet++;
        } else {
            console.log('⚠️ Kurulan cihaz alanı bulunamadı');
        }
        
        // Arızalı Cihaz Sayısı (sutun_28) - Sıra 5
        const arizaliInput = document.querySelector('input[name="sutun_28"]');
        if (arizaliInput) {
            const maxArizali = Math.floor(randomKurulan * 0.1); // Kurulanların %10'u kadar
            const randomArizali = Math.floor(Math.random() * (maxArizali + 1));
            arizaliInput.value = randomArizali;
            console.log('✅ Arızalı cihaz sayısı set edildi:', randomArizali);
            fieldsSet++;
        } else {
            console.log('⚠️ Arızalı cihaz alanı bulunamadı');
        }
        
        // Tamamlanma hesaplama
        calculateCompletion();
        
        // Diğer alanları da doldur (varsa)
        fillOtherFields();
        
        // Sonuç kontrolü
        if (fieldsSet === 0) {
            throw new Error('Hiçbir alan doldurulmadı. Form yapısı değişmiş olabilir.');
        }
        
        // Başarı mesajı
        showSuccessNotification(`Test verileri başarıyla eklendi! (${fieldsSet} alan dolduruldu)`);
        
        // Form alanlarına odaklan
        if (ilInput) {
            ilInput.focus();
            ilInput.blur();
        }
        
    } catch (error) {
        console.error('Test verisi oluşturma hatası:', error);
        showErrorNotification('⚠️ Test verisi oluşturulurken hata oluştu: ' + error.message);
    }
}

// Diğer alanları doldurma fonksiyonu
function fillOtherFields() {
    // Tarih alanları
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        const today = new Date();
        const randomDays = Math.floor(Math.random() * 365); // Son 1 yıl içinde
        const randomDate = new Date(today.getTime() - (randomDays * 24 * 60 * 60 * 1000));
        input.value = randomDate.toISOString().split('T')[0];
    });
    
    // Diğer text alanları
    const textInputs = document.querySelectorAll('input[type="text"]:not([name="sutun_25"]):not([name="sutun_24"])');
    const sampleTexts = ['Proje A', 'Görev B', 'Açıklama C', 'Test D', 'Durum E'];
    textInputs.forEach(input => {
        if (!input.value && !input.readOnly) {
            const randomText = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
            input.value = randomText;
        }
    });
}

// Başarı bildirimi fonksiyonu
function showSuccessNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 transform transition-all duration-300 max-w-sm';
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="text-2xl">✅</span>
            <div>
                <div class="font-medium">${message}</div>
                <div class="text-green-100 text-sm mt-1">Formu gözden geçirin ve kaydedin</div>
            </div>
        </div>
    `;
    document.body.appendChild(notification);
    
    // 5 saniye sonra kaldır
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 5000);
}

// Hata bildirimi fonksiyonu
function showErrorNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 transform transition-all duration-300 max-w-sm';
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="text-2xl">❌</span>
            <div>
                <div class="font-medium">${message}</div>
                <div class="text-red-100 text-sm mt-1">Lütfen sayfayı yenileyin</div>
            </div>
        </div>
    `;
    document.body.appendChild(notification);
    
    // 7 saniye sonra kaldır
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 7000);
}

// Sayfa yüklendiğinde setup
document.addEventListener('DOMContentLoaded', function() {
    console.log('Veri formu sayfası yüklendi');
    
    // Test butonu kontrolü
    const testButton = document.querySelector('button[onclick="generateFakeData()"]');
    if (testButton) {
        console.log('✅ Test verisi butonu bulundu');
    } else {
        console.log('⚠️ Test verisi butonu bulunamadı');
    }
    
    // Form alanı kontrolü
    const formInputs = document.querySelectorAll('input[name^="sutun_"]');
    console.log(`📝 Toplam form alanı: ${formInputs.length}`);
    
    // Form submit kontrolü
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Temel validasyon kontrolü
            const plakaInput = document.querySelector('input[name="sutun_24"]');
            const ilAdiInput = document.querySelector('input[name="sutun_25"]');
            
            if (plakaInput && ilAdiInput) {
                const plakaValue = plakaInput.value.trim();
                const ilAdiValue = ilAdiInput.value.trim();
                
                // Plaka alanına şehir ismi yazılmış mı?
                if (plakaValue && isNaN(plakaValue)) {
                    e.preventDefault();
                    showErrorNotification('Plaka alanına sadece rakam girebilirsiniz (01-81)');
                    plakaInput.focus();
                    return false;
                }
                
                // İl Adı alanına rakam yazılmış mı?
                if (ilAdiValue && !isNaN(ilAdiValue)) {
                    e.preventDefault();
                    showErrorNotification('İl Adı alanına şehir ismi yazın');
                    ilAdiInput.focus();
                    return false;
                }
                
                // Plaka aralık kontrolü
                if (plakaValue && !isNaN(plakaValue)) {
                    const plakaNum = parseInt(plakaValue);
                    if (plakaNum < 1 || plakaNum > 81) {
                        e.preventDefault();
                        showErrorNotification('Plaka kodu 01-81 arasında olmalıdır');
                        plakaInput.focus();
                        return false;
                    }
                }
            }
            
            // Başarılı form gönderimi için bildirim
            console.log('📝 Form gönderiliyor...');
        });
    }
    
    // Cihaz sayısı hesaplama
    setupAutoCalculation();
    
    // Test butonuna tıklama olaylarını dinle
    setupTestButtonEvents();
});

// Test butonu event setup
function setupTestButtonEvents() {
    const testButton = document.querySelector('button[onclick="generateFakeData()"]');
    if (testButton) {
        // Ek event listener ekle (onclick dışında)
        testButton.addEventListener('click', function(e) {
            console.log('🎲 Test butonu tıklandı');
            // onclick fonksiyonu zaten çalışacak, burada sadece log yapıyoruz
        });
        
        // Hover efekti ekle
        testButton.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
        });
        
        testButton.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    }
}

// Otomatik hesaplama için basit function
function setupAutoCalculation() {
    const cihazInputs = document.querySelectorAll('input[type="number"]');
    
    cihazInputs.forEach(input => {
        if (input.placeholder && input.placeholder.includes('0, 5, 25, 100')) {
            input.addEventListener('input', calculateCompletion);
        }
    });
}

// Basit tamamlanma hesaplama
function calculateCompletion() {
    try {
        const kurulacakInput = document.querySelector('input[name="sutun_26"]');
        const kurulanInput = document.querySelector('input[name="sutun_27"]');
        const tamamlanmaInputs = document.querySelectorAll('input[placeholder="Otomatik hesaplanacak"]');
        
        if (kurulacakInput && kurulanInput && tamamlanmaInputs.length > 0) {
            const kurulacak = parseInt(kurulacakInput.value) || 0;
            const kurulan = parseInt(kurulanInput.value) || 0;
            
            let yuzde = 0;
            if (kurulacak > 0) {
                yuzde = (kurulan / kurulacak) * 100;
                yuzde = Math.round(yuzde * 1000) / 1000; // 3 ondalık basamak
                yuzde = Math.min(100, Math.max(0, yuzde)); // 0-100 arasında sınırla
            }
            
            // Tüm tamamlanma alanlarını güncelle
            tamamlanmaInputs.forEach(input => {
                input.value = yuzde;
            });
            
            console.log(`✅ Tamamlanma yüzdesi hesaplandı: ${yuzde}% (${kurulan}/${kurulacak})`);
        }
    } catch (error) {
        console.error('Hesaplama hatası:', error);
    }
}

// Form değerlerini yükle (düzenleme modunda)
{% if is_edit and field_values_json %}
document.addEventListener('DOMContentLoaded', function() {
    const fieldValues = {{ field_values_json|safe }};
    console.log('Form değerleri yükleniyor:', fieldValues);
    
    // Her field için değeri set et
    for (const [fieldName, value] of Object.entries(fieldValues)) {
        const input = document.querySelector(`input[name="${fieldName}"], select[name="${fieldName}"]`);
        if (input && value !== null && value !== '') {
            input.value = value;
            console.log(`✅ ${fieldName} = ${value}`);
        }
    }
    
    // İl Adı dropdown'ları için özel işlem
    {% for sutun in aktif_sutunlar %}
        {% if sutun.ad == 'İl Adı' %}
            const ilSelect = document.querySelector('select[name="sutun_{{ sutun.id }}"]');
            if (ilSelect && fieldValues['sutun_{{ sutun.id }}']) {
                ilSelect.value = fieldValues['sutun_{{ sutun.id }}'];
            }
        {% endif %}
    {% endfor %}
});
{% endif %}
</script>
{% endblock %}
