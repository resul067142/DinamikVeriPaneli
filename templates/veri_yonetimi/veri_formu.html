{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{% if veri.pk %}Veri DÃ¼zenle{% else %}Yeni Veri Ekle{% endif %} - {{ app_name|default:"DVP" }}{% endblock %}

{% block content %}
<div class="min-h-screen p-4">
    <div class="w-full max-w-6xl mx-auto">
        
        <!-- Test Veri Butonu -->
        {% if not veri %}
        <div class="text-center mb-8">
            <button type="button" onclick="generateFakeData()" 
                    class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium text-lg">
                ğŸ² Test Verisi
            </button>
        </div>
        {% endif %}
        
        <!-- Form -->
        {% if aktif_sutunlar %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
                <form method="post" class="space-y-6" novalidate>
                    {% csrf_token %}
                    
                    <!-- Error Messages -->
                    {% if form.errors %}
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-red-600">âš ï¸</span>
                                <h3 class="text-red-800 font-medium">Form hatalarÄ± bulundu</h3>
                            </div>
                            <ul class="text-red-700 text-sm space-y-1">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>â€¢ {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- Form Fields Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for sutun in aktif_sutunlar %}
                            <div class="{% if sutun.ad == 'Plaka' or sutun.ad == 'Ä°l AdÄ±' %}md:col-span-2{% endif %}">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    {% if sutun.ad == 'Plaka' %}
                                        ğŸš— {{ sutun.ad }}
                                        <span class="text-red-500 ml-1">*</span>
                                    {% elif sutun.ad == 'Ä°l AdÄ±' %}
                                        ğŸ™ï¸ {{ sutun.ad }}
                                        <span class="text-red-500 ml-1">*</span>
                                    {% elif 'Cihaz' in sutun.ad %}
                                        ğŸ“± {{ sutun.ad }}
                                    {% elif 'Tarih' in sutun.ad %}
                                        ğŸ“… {{ sutun.ad }}
                                    {% elif 'Durum' in sutun.ad %}
                                        ğŸ” {{ sutun.ad }}
                                    {% else %}
                                        ğŸ“ {{ sutun.ad }}
                                    {% endif %}
                                </label>
                                
                                <!-- Input Fields -->
                                {% if sutun.ad == 'Plaka' %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="Plaka numarasÄ± girin (sÄ±nÄ±r yok)"
                                           title="Plaka numarasÄ± girin">
                                    
                                {% elif sutun.ad == 'Ä°l AdÄ±' %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="Adana, Ankara, Ä°stanbul..."
                                           maxlength="50">
                                    
                                {% elif 'Cihaz' in sutun.ad %}
                                    <input type="number" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="0, 5, 25, 100..."
                                           min="0"
                                           step="1">
                                    
                                {% elif 'Durum' in sutun.ad or 'Tamamlanma' in sutun.ad %}
                                    <input type="number" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors bg-gray-100"
                                           placeholder="Otomatik hesaplanacak"
                                           min="0"
                                           max="100"
                                           step="1"
                                           readonly
                                           title="Bu alan otomatik hesaplanÄ±r">
                                    <div class="text-xs text-gray-500 mt-1">
                                        ğŸ’¡ Kurulan / Kurulacak oranÄ±na gÃ¶re otomatik hesaplanÄ±r
                                    </div>
                                    
                                {% elif 'Tarih' in sutun.ad %}
                                    <input type="date" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    
                                {% else %}
                                    <input type="text" 
                                           name="sutun_{{ sutun.id }}" 
                                           id="id_sutun_{{ sutun.id }}"
                                           value=""
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                           placeholder="{{ sutun.ad }} deÄŸerini girin">
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4 pt-8">
                        <button type="submit" 
                                class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium text-lg">
                            {% if veri.pk %}ğŸ’¾ GÃ¼ncelle{% else %}â• Veriyi Ekle{% endif %}
                        </button>
                        <a href="{% url 'veri_yonetimi:veri_listesi' %}" 
                           class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium text-lg">
                            âŒ Ä°ptal
                        </a>
                    </div>
                </form>
            </div>
        {% else %}
            <!-- No Columns Available -->
            <div class="bg-white rounded-lg shadow-md border border-gray-100 p-8 text-center">
                <div class="text-6xl mb-4">âš ï¸</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">SÃ¼tun BulunamadÄ±</h3>
                <p class="text-gray-600 mb-6">
                    Veri eklemek iÃ§in Ã¶nce sÃ¼tun tanÄ±mlamalarÄ± yapÄ±lmalÄ±dÄ±r.
                </p>
                <div class="flex flex-wrap justify-center gap-3">
                    <a href="{% url 'veri_yonetimi:sutun_ekle' %}" 
                       class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        â• Ä°lk SÃ¼tunu Ekle
                    </a>
                    <a href="{% url 'veri_yonetimi:ana_sayfa' %}" 
                       class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
                        ğŸ  Ana Sayfa
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
function generateFakeData() {
    console.log('ğŸ² Test verisi oluÅŸturuluyor...');
    
    try {
        // Plaka (sutun_23)
        const plakaInput = document.querySelector('input[name="sutun_23"]');
        if (plakaInput) {
            const randomPlaka = Math.floor(Math.random() * 999) + 1;
            plakaInput.value = randomPlaka.toString();
            console.log('ğŸš— Plaka set edildi:', plakaInput.value);
        }
        
        // Ä°l AdÄ± (sutun_24)
        const iller = ['Adana', 'Ankara', 'Ä°stanbul', 'Ä°zmir', 'Bursa', 'Antalya'];
        const ilInput = document.querySelector('input[name="sutun_24"]');
        if (ilInput) {
            const randomIl = iller[Math.floor(Math.random() * iller.length)];
            ilInput.value = randomIl;
            console.log('ğŸ™ï¸ Ä°l adÄ± set edildi:', ilInput.value);
        }
        
        // Kurulacak Cihaz SayÄ±sÄ± (sutun_25)
        const randomKurulacak = Math.floor(Math.random() * 100) + 10;
        const kurulacakInput = document.querySelector('input[name="sutun_25"]');
        if (kurulacakInput) {
            kurulacakInput.value = randomKurulacak;
            console.log('ğŸ“± Kurulacak cihaz sayÄ±sÄ± set edildi:', randomKurulacak);
        }
        
        // Kurulan Cihaz SayÄ±sÄ± (sutun_26)
        const randomKurulan = Math.floor(Math.random() * randomKurulacak);
        const kurulanInput = document.querySelector('input[name="sutun_26"]');
        if (kurulanInput) {
            kurulanInput.value = randomKurulan;
            console.log('ğŸ“± Kurulan cihaz sayÄ±sÄ± set edildi:', randomKurulan);
        }
        
        // ArÄ±zalÄ± Cihaz SayÄ±sÄ± (sutun_27)
        const randomArizali = Math.floor(Math.random() * 20);
        const arizaliInput = document.querySelector('input[name="sutun_27"]');
        if (arizaliInput) {
            arizaliInput.value = randomArizali;
            console.log('ğŸ“± ArÄ±zalÄ± cihaz sayÄ±sÄ± set edildi:', randomArizali);
        }
        
        // Tamamlanma Durumu (sutun_28) - readonly olduÄŸu iÃ§in otomatik hesaplanÄ±r
        const tamamlanmaInput = document.querySelector('input[name="sutun_28"]');
        if (tamamlanmaInput) {
            const tamamlanmaYuzdesi = Math.round((randomKurulan / randomKurulacak) * 100);
            tamamlanmaInput.value = tamamlanmaYuzdesi;
            console.log('ğŸ” Tamamlanma yÃ¼zdesi set edildi:', tamamlanmaYuzdesi);
        }
        
        // DiÄŸer dinamik sÃ¼tunlar (sutun_32, sutun_33, sutun_35)
        const dinamikInputs = ['sutun_32', 'sutun_33', 'sutun_35'];
        dinamikInputs.forEach(inputName => {
            const input = document.querySelector(`input[name="${inputName}"]`);
            if (input) {
                const randomText = `Test_${Math.floor(Math.random() * 1000)}`;
                input.value = randomText;
                console.log(`ğŸ“ ${inputName} deÄŸeri set edildi: ${randomText}`);
            }
        });
        
        // BaÅŸarÄ± mesajÄ±
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        notification.innerHTML = 'ğŸ² Test verileri baÅŸarÄ±yla eklendi!';
        document.body.appendChild(notification);
        
        // 3 saniye sonra kaldÄ±r
        setTimeout(() => {
            notification.remove();
        }, 3000);
        
        console.log('âœ… Test verisi oluÅŸturma tamamlandÄ±');
        
    } catch (error) {
        console.error('âŒ Test verisi oluÅŸturulurken hata:', error);
        alert('Test verisi oluÅŸturulurken hata oluÅŸtu: ' + error.message);
    }
}

// Sayfa yÃ¼klendiÄŸinde debug bilgileri
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“„ Veri formu sayfasÄ± yÃ¼klendi');
    
    // Mevcut input alanlarÄ±nÄ± kontrol et
    const inputs = document.querySelectorAll('input[name*="sutun_"]');
    console.log('ğŸ” Bulunan input alanlarÄ±:', inputs.length);
    
    inputs.forEach((input, index) => {
        console.log(`Input ${index + 1}:`, input.name, input.placeholder);
    });
    
    // Form submit olayÄ±nÄ± yakala
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('ğŸ“¤ Form submit ediliyor...');
            
            // TÃ¼m form deÄŸerlerini kontrol et
            const formData = new FormData(form);
            console.log('ğŸ“‹ Form verileri:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: "${value}"`);
            }
            
            // BoÅŸ alanlarÄ± kontrol et
            const emptyFields = [];
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    emptyFields.push(input.name);
                }
            });
            
            if (emptyFields.length > 0) {
                console.log('âš ï¸ BoÅŸ alanlar:', emptyFields);
            } else {
                console.log('âœ… TÃ¼m alanlar dolu');
            }
        });
    }
    
    // Cihaz sayÄ±sÄ± input'larÄ±na event listener ekle
    setupAutoCalculation();
});

// Otomatik hesaplama iÃ§in event listener'larÄ± ayarla
function setupAutoCalculation() {
    const cihazInputs = document.querySelectorAll('input[type="number"]');
    
    cihazInputs.forEach(input => {
        if (input.placeholder && (input.placeholder.includes('0, 5, 25, 100') || input.placeholder.includes('Kurulacak') || input.placeholder.includes('Kurulan') || input.placeholder.includes('ArÄ±zalÄ±'))) {
            input.addEventListener('input', calculateCompletion);
            input.addEventListener('change', calculateCompletion);
            console.log('ğŸ”— Event listener eklendi:', input.name);
        }
    });
}

// Tamamlanma durumunu otomatik hesapla
function calculateCompletion() {
    console.log('ğŸ§® Tamamlanma durumu hesaplanÄ±yor...');
    
    try {
        // Kurulacak cihaz sayÄ±sÄ±nÄ± bul
        let kurulacakInput = null;
        const kurulacakInputs = document.querySelectorAll('input[type="number"]');
        
        kurulacakInputs.forEach(input => {
            if (input.placeholder && input.placeholder.includes('0, 5, 25, 100')) {
                kurulacakInput = input;
            }
        });
        
        // Kurulan cihaz sayÄ±sÄ±nÄ± bul
        let kurulanInput = null;
        kurulacakInputs.forEach(input => {
            if (input.placeholder && input.placeholder.includes('0, 5, 25, 100') && input !== kurulacakInput) {
                kurulanInput = input;
            }
        });
        
        // Tamamlanma durumu input'unu bul
        const tamamlanmaInput = document.querySelector('input[placeholder="Otomatik hesaplanacak"]');
        
        if (kurulacakInput && kurulanInput && tamamlanmaInput) {
            const kurulacak = parseInt(kurulacakInput.value) || 0;
            const kurulan = parseInt(kurulanInput.value) || 0;
            
            console.log('ğŸ“Š Kurulacak:', kurulacak, 'Kurulan:', kurulan);
            
            if (kurulacak > 0) {
                const tamamlanmaYuzdesi = Math.round((kurulan / kurulacak) * 100);
                tamamlanmaInput.value = tamamlanmaYuzdesi;
                console.log('âœ… Tamamlanma yÃ¼zdesi hesaplandÄ±:', tamamlanmaYuzdesi);
                
                // Renk kodlamasÄ± ekle
                if (tamamlanmaYuzdesi >= 80) {
                    tamamlanmaInput.style.backgroundColor = '#dcfce7'; // YeÅŸil
                    tamamlanmaInput.style.borderColor = '#16a34a';
                } else if (tamamlanmaYuzdesi >= 60) {
                    tamamlanmaInput.style.backgroundColor = '#fef3c7'; // SarÄ±
                    tamamlanmaInput.style.borderColor = '#d97706';
                } else if (tamamlanmaYuzdesi >= 40) {
                    tamamlanmaInput.style.backgroundColor = '#fed7aa'; // Turuncu
                    tamamlanmaInput.style.borderColor = '#ea580c';
                } else {
                    tamamlanmaInput.style.backgroundColor = '#fecaca'; // KÄ±rmÄ±zÄ±
                    tamamlanmaInput.style.borderColor = '#dc2626';
                }
            } else {
                tamamlanmaInput.value = 0;
                tamamlanmaInput.style.backgroundColor = '#f3f4f6'; // Gri
                tamamlanmaInput.style.borderColor = '#d1d5db';
            }
        }
        
    } catch (error) {
        console.error('âŒ Hesaplama hatasÄ±:', error);
    }
}

// Form deÄŸerlerini yÃ¼kle (dÃ¼zenleme modunda)
{% if is_edit and field_values_json %}
document.addEventListener('DOMContentLoaded', function() {
    const fieldValues = {{ field_values_json|safe }};
    console.log('Form deÄŸerleri yÃ¼kleniyor:', fieldValues);
    
    // Her field iÃ§in deÄŸeri set et
    for (const [fieldName, value] of Object.entries(fieldValues)) {
        const input = document.querySelector(`input[name="${fieldName}"], select[name="${fieldName}"]`);
        if (input && value !== null && value !== '') {
            input.value = value;
            console.log(`âœ… ${fieldName} = ${value}`);
        }
    }
    
    // Ä°l AdÄ± dropdown'larÄ± iÃ§in Ã¶zel iÅŸlem
    {% for sutun in aktif_sutunlar %}
        {% if sutun.ad == 'Ä°l AdÄ±' %}
            const ilSelect = document.querySelector('select[name="sutun_{{ sutun.id }}"]');
            if (ilSelect && fieldValues['sutun_{{ sutun.id }}']) {
                ilSelect.value = fieldValues['sutun_{{ sutun.id }}'];
            }
        {% endif %}
    {% endfor %}
});
{% endif %}
</script>
{% endblock %}
