{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Ana Sayfa - Genel Bakış ve İstatistikler - {{ app_name|default:"DVP" }}{% endblock %}

{% block content %}
<div class="space-y-4">

    
    <!-- Yönetim ve Destek Kartları -->
    <div class="card p-3 bg-gradient-to-r from-gray-50 to-blue-50 border border-gray-200">
        <h3 class="text-base font-semibold text-gray-800 mb-3 text-center">👥 Yönetim ve Destek Ekibi</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
            <!-- Yönetici Kartı -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-all duration-300 hover:scale-105" data-role="yonetici">
                <div class="p-3 text-center">
                    <div class="w-12 h-12 mx-auto mb-2 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center">
                        <span class="text-2xl">👔</span>
                    </div>
                    <h4 class="text-sm font-bold text-gray-800 mb-1">Resul AKTAŞ</h4>
                    <p class="text-xs text-gray-600 mb-2">Genel Koordinasyon</p>
                    <div class="flex items-center justify-center space-x-2 text-xs text-gray-500">
                        <span>📧 yonetici@dvp.com</span>
                    </div>
                    {% if user.is_superuser %}
                    <div class="mt-3">
                        <button onclick="editTeamMember('yonetici')" class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 text-xs rounded-full transition-colors">
                            ✏️ Düzenle
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Yazılım Kartı -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-all duration-300 hover:scale-105" data-role="yazilim">
                <div class="p-3 text-center">
                    <div class="w-12 h-12 mx-auto mb-2 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center">
                        <span class="text-2xl">💻</span>
                    </div>
                    <h4 class="text-sm font-bold text-gray-800 mb-1">Mehmet Demir</h4>
                    <p class="text-xs text-gray-600 mb-2">Geliştirme & Bakım</p>
                    <div class="flex items-center justify-center space-x-2 text-xs text-gray-500">
                        <span>📧 yazilim@dvp.com</span>
                    </div>
                    {% if user.is_superuser %}
                    <div class="mt-3">
                        <button onclick="editTeamMember('yazilim')" class="px-2 py-1 bg-green-100 hover:bg-green-200 text-green-700 text-xs rounded-full transition-colors">
                            ✏️ Düzenle
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Teknik Destek Kartı -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-all duration-300 hover:scale-105" data-role="destek">
                <div class="p-3 text-center">
                    <div class="w-12 h-12 mx-auto mb-2 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center">
                        <span class="text-2xl">🔧</span>
                    </div>
                    <h4 class="text-sm font-bold text-gray-800 mb-1">Fatma Kaya</h4>
                    <p class="text-xs text-gray-600 mb-2">Sistem & Cihaz</p>
                    <div class="flex items-center justify-center space-x-2 text-xs text-gray-500">
                        <span>📧 destek@dvp.com</span>
                    </div>
                    {% if user.is_superuser %}
                    <div class="mt-3">
                        <button onclick="editTeamMember('destek')" class="px-2 py-1 bg-orange-100 hover:bg-orange-200 text-orange-700 text-xs rounded-full transition-colors">
                            ✏️ Düzenle
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- EKP Kartı -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-all duration-300 hover:scale-105" data-role="ekp">
                <div class="p-3 text-center">
                    <div class="w-12 h-12 mx-auto mb-2 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center">
                        <span class="text-2xl">📋</span>
                    </div>
                    <h4 class="text-sm font-bold text-gray-800 mb-1">Ali Özkan</h4>
                    <p class="text-xs text-gray-600 mb-2">Proje Yönetimi</p>
                    <div class="flex items-center justify-center space-x-2 text-xs text-gray-500">
                        <span>📧 ekp@dvp.com</span>
                    </div>
                    {% if user.is_superuser %}
                    <div class="mt-3">
                        <button onclick="editTeamMember('ekp')" class="px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 text-xs rounded-full transition-colors">
                            ✏️ Düzenle
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Türkiye Geneli Cihaz Durumu -->
    {% if turkiye_toplam_kurulacak or turkiye_toplam_kurulan %}
    <div class="card p-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-3 text-center">🇹🇷 Türkiye Geneli Cihaz Durumu</h3>
                 <!-- Ana İstatistikler -->
         <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-center mb-4">
             <div class="bg-blue-50 rounded p-2 border border-blue-200">
                 <div class="text-lg font-bold text-blue-600">{{ turkiye_toplam_kurulacak|default:"0" }}</div>
                 <div class="text-xs text-blue-800">🎯 Hedef</div>
             </div>
             
             <div class="bg-green-50 rounded p-2 border border-green-200">
                 <div class="text-lg font-bold text-green-600">{{ turkiye_toplam_kurulan|default:"0" }}</div>
                 <div class="text-xs text-green-800">🚀 Tamamlanan</div>
             </div>
             
             <div class="bg-orange-50 rounded p-2 border border-orange-200">
                 <div class="text-lg font-bold text-orange-600">{{ turkiye_toplam_kalan|default:"0" }}</div>
                 <div class="text-xs text-orange-800">⏳ Kalan</div>
             </div>
             
             <div class="bg-red-50 rounded p-2 border border-red-200">
                 <div class="text-lg font-bold text-red-600">{{ turkiye_toplam_arizali|default:"0" }}</div>
                 <div class="text-xs text-red-800">⚠️ Arızalı</div>
             </div>
             
             <div class="bg-purple-50 rounded p-2 border border-purple-200">
                 <div class="text-lg font-bold text-purple-600">%{{ turkiye_tamamlanma_yuzdesi|default:"0" }}</div>
                 <div class="text-xs text-purple-800">📊 Tamamlanma</div>
             </div>
         </div>
        
                 <!-- Progress Bar -->
    </div>
    {% endif %}

    <!-- İl Bazında Cihaz Durumu -->
    {% if il_bazinda_istatistikler %}
    <div class="card p-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-3 text-center">🏛️ İl Bazında Cihaz Durumu</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {% for istatistik in il_bazinda_istatistikler|slice:":6" %}
            <div class="bg-gray-50 rounded p-3">
                <h4 class="font-semibold text-gray-800 text-sm mb-2">{{ istatistik.il_adi }}</h4>
                                 <!-- İlerleme Durumu Progress Bar -->
                 <div class="mb-3">
                     <div class="flex justify-between text-xs text-gray-600 mb-1">
                         <span>İlerleme</span>
                         <span class="font-medium">%{{ istatistik.tamamlanma_yuzdesi|default:"0" }}</span>
                     </div>
                     <div class="w-full bg-white border border-gray-200 rounded-full h-2 relative overflow-hidden">
                         <div class="h-2 rounded-full transition-all duration-500 ease-out" 
                              style="width: {{ istatistik.tamamlanma_yuzdesi|default:0 }}%;
                                     background: {% if istatistik.tamamlanma_yuzdesi >= 80 %}linear-gradient(90deg, #10b981, #059669){% elif istatistik.tamamlanma_yuzdesi >= 60 %}linear-gradient(90deg, #3b82f6, #2563eb){% elif istatistik.tamamlanma_yuzdesi >= 40 %}linear-gradient(90deg, #f59e0b, #d97706){% else %}linear-gradient(90deg, #ef4444, #dc2626){% endif %};">
                         </div>
                     </div>
                 </div>
                 
                 <!-- Cihaz Sayıları Grid -->
                 <div class="grid grid-cols-4 gap-2 text-center text-xs mb-2">
                     <div class="text-blue-600 font-medium">{{ istatistik.veri.kurulacak_cihaz_sayisi|default:"0" }}</div>
                     <div class="text-green-600 font-medium">{{ istatistik.veri.kurulan_cihaz_sayisi|default:"0" }}</div>
                     <div class="text-orange-600 font-medium">{{ istatistik.kalan_cihaz|default:"0" }}</div>
                     <div class="text-red-600 font-medium">{{ istatistik.veri.arizali_cihaz_sayisi|default:"0" }}</div>
                 </div>
                 
                 <!-- Durum Etiketi -->
                 <div class="text-center">
                     <span class="text-xs px-2 py-1 rounded-full font-medium
                         {% if istatistik.tamamlanma_yuzdesi >= 80 %}bg-green-100 text-green-800 border border-green-200
                         {% elif istatistik.tamamlanma_yuzdesi >= 60 %}bg-blue-100 text-blue-800 border border-blue-200
                         {% elif istatistik.tamamlanma_yuzdesi >= 40 %}bg-orange-100 text-orange-800 border border-orange-200
                         {% else %}bg-red-100 text-red-800 border border-red-200{% endif %}">
                         {% if istatistik.tamamlanma_yuzdesi >= 80 %}🏆 Mükemmel
                         {% elif istatistik.tamamlanma_yuzdesi >= 60 %}👍 İyi
                         {% elif istatistik.tamamlanma_yuzdesi >= 40 %}⚠️ Orta
                         {% else %}📈 Başlangıç{% endif %}
                     </span>
                 </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
// Ekip üyesi düzenleme fonksiyonu
function editTeamMember(role) {
    const memberData = {
        'yonetici': {
            title: 'Genel Koordinatör',
            name: 'Resul AKTAŞ',
            email: 'yonetici@dvp.com',
            phone: '+90 555 123 4567',
            department: 'Genel Koordinasyon',
            avatar: '👔',
            photo: null
        },
        'yazilim': {
            title: 'Yazılım Geliştirici',
            name: 'Mehmet Demir',
            email: 'yazilim@dvp.com',
            phone: '+90 555 234 5678',
            department: 'Geliştirme & Bakım',
            avatar: '💻',
            photo: null
        },
        'destek': {
            title: 'Teknik Destek',
            name: 'Fatma Kaya',
            email: 'destek@dvp.com',
            phone: '+90 555 345 6789',
            department: 'Sistem & Cihaz',
            avatar: '🔧',
            photo: null
        },
        'ekp': {
            title: 'Proje Yöneticisi',
            name: 'Ali Özkan',
            email: 'ekp@dvp.com',
            phone: '+90 555 456 7890',
            department: 'Proje Yönetimi',
            avatar: '📋',
            photo: null
        }
    };
    
    const member = memberData[role];
    
    // Modal oluştur
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800">${member.title} Bilgilerini Düzenle</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-xl">
                    ✕
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- Avatar Seçimi -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">🖼️ Profil Fotoğrafı</label>
                    <div class="flex items-center space-x-3">
                        <div id="avatarPreview" class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-2xl text-white overflow-hidden">
                            ${member.photo ? `<img src="${member.photo}" alt="Profil" class="w-full h-full object-cover">` : member.avatar}
                        </div>
                        <div class="flex-1">
                            <input type="file" id="photoInput" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="previewPhoto(this)">
                            <p class="text-xs text-gray-500 mt-1">PNG, JPG veya GIF (max 2MB)</p>
                        </div>
                    </div>
                </div>
                
                <!-- Ad Soyad -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">👤 Ad Soyad</label>
                    <input type="text" id="nameInput" value="${member.name}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
                
                <!-- E-posta -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">📧 E-posta</label>
                    <input type="email" id="emailInput" value="${member.email}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
                
                <!-- Telefon -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">📱 Telefon</label>
                    <input type="tel" id="phoneInput" value="${member.phone}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
                
                <!-- Departman -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">🏢 Departman</label>
                    <input type="text" id="departmentInput" value="${member.department}" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="saveTeamMember('${role}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                    💾 Kaydet
                </button>
                <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg font-medium transition-colors">
                    ❌ İptal
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Fotoğraf önizleme fonksiyonu
function previewPhoto(input) {
    const file = input.files[0];
    if (file) {
        // Dosya boyutu kontrolü (2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('Dosya boyutu 2MB\'dan büyük olamaz!');
            input.value = '';
            return;
        }
        
        // Dosya türü kontrolü
        if (!file.type.startsWith('image/')) {
            alert('Lütfen geçerli bir resim dosyası seçin!');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const avatarPreview = document.getElementById('avatarPreview');
            avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Profil" class="w-full h-full object-cover">`;
            avatarPreview.className = 'w-16 h-16 rounded-full overflow-hidden';
        };
        reader.readAsDataURL(file);
    }
}

// Ekip üyesi kaydetme fonksiyonu
function saveTeamMember(role) {
    // Form verilerini al
    const name = document.getElementById('nameInput').value.trim();
    const email = document.getElementById('emailInput').value.trim();
    const phone = document.getElementById('phoneInput').value.trim();
    const department = document.getElementById('departmentInput').value.trim();
    const photoInput = document.getElementById('photoInput');
    
    // Validasyon
    if (!name || !email || !phone || !department) {
        showNotification('Lütfen tüm alanları doldurun!', 'error');
        return;
    }
    
    if (!email.includes('@')) {
        showNotification('Geçerli bir e-posta adresi girin!', 'error');
        return;
    }
    
    // Fotoğraf işleme
    let photoData = null;
    if (photoInput.files[0]) {
        const file = photoInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            photoData = e.target.result;
            
            // LocalStorage'a kaydet
            const memberData = {
                name: name,
                email: email,
                phone: phone,
                department: department,
                photo: photoData,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem(`teamMember_${role}`, JSON.stringify(memberData));
            
            // Kartı güncelle
            updateTeamMemberCard(role, memberData);
            
            showNotification(`${role.charAt(0).toUpperCase() + role.slice(1)} bilgileri kaydedildi!`, 'success');
            
            // Modal'ı kapat
            document.querySelector('.fixed').remove();
        };
        reader.readAsDataURL(file);
    } else {
        // Fotoğraf yoksa sadece diğer bilgileri kaydet
        const memberData = {
            name: name,
            email: email,
            phone: phone,
            department: department,
            photo: null,
            updatedAt: new Date().toISOString()
        };
        
        localStorage.setItem(`teamMember_${role}`, JSON.stringify(memberData));
        
        // Kartı güncelle
        updateTeamMemberCard(role, memberData);
        
        showNotification(`${role.charAt(0).toUpperCase() + role.slice(1)} bilgileri kaydedildi!`, 'success');
        
        // Modal'ı kapat
        document.querySelector('.fixed').remove();
    }
}

// Ekip üyesi kartını güncelleme fonksiyonu
function updateTeamMemberCard(role, memberData) {
    const card = document.querySelector(`[data-role="${role}"]`);
    if (card) {
        // Avatar güncelle
        const avatarDiv = card.querySelector('.w-12.h-12');
        if (memberData.photo) {
            avatarDiv.innerHTML = `<img src="${memberData.photo}" alt="${memberData.name}" class="w-10 h-10 rounded-full object-cover">`;
        } else {
            // Varsayılan avatar'ı geri yükle
            const defaultAvatars = {
                'yonetici': '👔',
                'yazilim': '💻',
                'destek': '🔧',
                'ekp': '📋'
            };
            avatarDiv.innerHTML = `<span class="text-2xl">${defaultAvatars[role]}</span>`;
        }
        
        // İsim güncelle
        const nameElement = card.querySelector('h4');
        if (nameElement) nameElement.textContent = memberData.name;
        
        // Departman güncelle
        const deptElement = card.querySelector('p');
        if (deptElement) deptElement.textContent = memberData.department;
        
        // E-posta güncelle
        const emailElement = card.querySelector('.text-xs.text-gray-500 span');
        if (emailElement) emailElement.textContent = `📧 ${memberData.email}`;
    }
}

// Sayfa yüklendiğinde kaydedilmiş verileri yükle
document.addEventListener('DOMContentLoaded', function() {
    // Kaydedilmiş ekip üyesi verilerini yükle
    const roles = ['yonetici', 'yazilim', 'destek', 'ekp'];
    roles.forEach(role => {
        const savedData = localStorage.getItem(`teamMember_${role}`);
        if (savedData) {
            try {
                const memberData = JSON.parse(savedData);
                updateTeamMemberCard(role, memberData);
            } catch (e) {
                console.error('Kaydedilmiş veri yüklenemedi:', e);
            }
        }
    });
});

// Bildirim gösterme fonksiyonu
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
    
    const colors = {
        'success': 'bg-green-500 text-white',
        'error': 'bg-red-500 text-white',
        'warning': 'bg-yellow-500 text-white',
        'info': 'bg-blue-500 text-white'
    };
    
    notification.className += ` ${colors[type] || colors.info}`;
    notification.innerHTML = `
        <div class="flex items-center space-x-2">
            <span>${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}</span>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animasyon
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Otomatik kaldır
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}
</script>
{% endblock %}
