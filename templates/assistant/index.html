{% extends 'base.html' %}

{% block title %}AI Asistan - {{ app_name|default:"DVP" }}{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
<script>
let isListening = false;
let isSpeaking = false;
let emotion = 'neutral';
let mediaRecorder;
let audioChunks = [];
let useElevenLabs = true; // VarsayÄ±lan olarak ElevenLabs
let streamAudio = false; // Ses akÄ±ÅŸÄ±
let currentAudio = null;

// AsistanÄ± baÅŸlat
document.addEventListener('DOMContentLoaded', function() {
    // HoÅŸgeldiniz mesajÄ±nÄ± oynat
    setTimeout(() => {
        speakText("Merhaba! Size bugÃ¼n nasÄ±l yardÄ±mcÄ± olabilirim?");
        updateAvatar();
    }, 1000);
});

// AvatarÄ± duruma gÃ¶re gÃ¼ncelle
function updateAvatar() {
    // Elementlerin varlÄ±ÄŸÄ±nÄ± kontrol et
    const avatar = document.getElementById('assistantAvatar');
    const mouth = document.getElementById('mouth');
    const leftEye = document.getElementById('leftEye');
    const rightEye = document.getElementById('rightEye');
    
    // Herhangi bir element eksikse erken dÃ¶n
    if (!avatar || !mouth || !leftEye || !rightEye) {
        return;
    }
    
    // TÃ¼m animasyonlarÄ± sÄ±fÄ±rla
    avatar.classList.remove('animate-pulse', 'animate-bounce');
    mouth.classList.remove('mouth-speaking', 'mouth-neutral');
    leftEye.classList.remove('eye-blinking');
    rightEye.classList.remove('eye-blinking');
    
    if (isSpeaking) {
        // KonuÅŸma animasyonu
        mouth.classList.add('mouth-speaking');
        avatar.classList.add('animate-pulse');
    } else if (isListening) {
        // Dinleme animasyonu
        avatar.classList.add('animate-pulse');
    } else if (emotion === 'thinking') {
        // DÃ¼ÅŸÃ¼nme animasyonu
        leftEye.classList.add('eye-blinking');
        rightEye.classList.add('eye-blinking');
    } else {
        // NÃ¶tr durum
        mouth.classList.add('mouth-neutral');
    }
    
    // Duygu gÃ¶stergeleri
    const emotionIndicator = document.getElementById('emotionIndicator');
    if (emotionIndicator) {
        emotionIndicator.innerHTML = '';
        
        if (emotion === 'smiling') {
            emotionIndicator.innerHTML = '<span class="text-2xl">ðŸ˜Š</span>';
        } else if (emotion === 'thinking') {
            emotionIndicator.innerHTML = '<span class="text-2xl">ðŸ¤”</span>';
        }
    }
}

// TTS motorunu deÄŸiÅŸtir
function toggleTTS() {
    useElevenLabs = !useElevenLabs;
    const ttsButton = document.getElementById('ttsButton');
    if (ttsButton) {
        ttsButton.innerHTML = useElevenLabs ? 
            '<span class="mr-2">ðŸŽ¤</span> ElevenLabs' : 
            '<span class="mr-2">ðŸ”Š</span> gTTS';
        showNotification(`TTS motoru ${useElevenLabs ? 'ElevenLabs' : 'gTTS'} olarak deÄŸiÅŸtirildi`, 'info');
    }
}

// Ses akÄ±ÅŸÄ±nÄ± deÄŸiÅŸtir
function toggleStreaming() {
    streamAudio = !streamAudio;
    const streamingButton = document.getElementById('streamingButton');
    if (streamingButton) {
        streamingButton.innerHTML = streamAudio ? 
            '<span class="mr-2">ðŸ“¡</span> AkÄ±ÅŸ AÃ‡IK' : 
            '<span class="mr-2">ðŸ“¡</span> AkÄ±ÅŸ KAPALI';
        streamingButton.className = streamAudio ? 
            'btn btn-success' : 
            'btn btn-info';
        showNotification(`Ses akÄ±ÅŸÄ± ${streamAudio ? 'etkin' : 'devre dÄ±ÅŸÄ±'}`, 'info');
    }
}

// Mikrofonu aÃ§/kapat
function toggleMicrophone() {
    const micButton = document.getElementById('micButton');
    const micIcon = document.getElementById('micIcon');
    
    if (!isListening) {
        startListening();
        if (micButton) {
            micButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            micButton.classList.add('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
        }
        if (micIcon) {
            micIcon.textContent = 'stop';
        }
        const micIndicator = document.getElementById('micIndicator');
        if (micIndicator) {
            micIndicator.classList.remove('hidden');
        }
        isListening = true;
        emotion = 'speaking';
    } else {
        stopListening();
        if (micButton) {
            micButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
            micButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
        }
        if (micIcon) {
            micIcon.textContent = 'mic';
        }
        const micIndicator = document.getElementById('micIndicator');
        if (micIndicator) {
            micIndicator.classList.add('hidden');
        }
        isListening = false;
        emotion = 'neutral';
    }
    
    updateAvatar();
}

// Mikrofonla dinlemeye baÅŸla
async function startListening() {
    isListening = true;
    emotion = 'speaking';
    updateAvatar();
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            await sendAudioToBackend(audioBlob);
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
    } catch (error) {
        console.error('Mikrofon eriÅŸim hatasÄ±:', error);
        showNotification('Mikrofon eriÅŸim hatasÄ±: ' + error.message, 'error');
        isListening = false;
        emotion = 'neutral';
        // ArayÃ¼zÃ¼ sÄ±fÄ±rla
        const micButton = document.getElementById('micButton');
        const micIcon = document.getElementById('micIcon');
        if (micButton) {
            micButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
            micButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
        }
        if (micIcon) {
            micIcon.textContent = 'mic';
        }
        const micIndicator = document.getElementById('micIndicator');
        if (micIndicator) {
            micIndicator.classList.add('hidden');
        }
        updateAvatar();
    }
}

// Dinlemeyi durdur
function stopListening() {
    isListening = false;
    emotion = 'neutral';
    updateAvatar();
    
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
}

// Ses dosyasÄ±nÄ± sunucuya gÃ¶nder
async function sendAudioToBackend(audioBlob) {
    const formData = new FormData();
    formData.append('audio', audioBlob, 'recording.webm');
    
    try {
        showNotification('Sesiniz iÅŸleniyor...', 'info');
        
        const response = await fetch('/assistant/transcribe/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value
            }
        });
        
        const data = await response.json();
        
        if (data.text) {
            const userInput = document.getElementById('userInput');
            if (userInput) {
                userInput.value = data.text;
            }
            await sendQuestion(data.text);
        } else {
            showNotification('Sesiniz anlaÅŸÄ±lamadÄ±. LÃ¼tfen tekrar deneyin.', 'error');
        }
    } catch (error) {
        console.error('Ses gÃ¶nderme hatasÄ±:', error);
        showNotification('Ses iÅŸleme hatasÄ±: ' + error.message, 'error');
    }
}

// Metin sorusunu sunucuya gÃ¶nder
async function sendQuestion(question = null) {
    const userInput = document.getElementById('userInput');
    const questionText = question || (userInput ? userInput.value.trim() : '');
    
    if (!questionText) {
        showNotification('LÃ¼tfen bir soru girin veya sesli komut verin', 'warning');
        return;
    }
    
    // KullanÄ±cÄ± mesajÄ±nÄ± sohbete ekle
    addChatMessage(questionText, 'user');
    
    try {
        // YÃ¼kleniyor durumunu gÃ¶ster
        const sendButton = document.getElementById('sendButton');
        if (sendButton) {
            sendButton.disabled = true;
            sendButton.innerHTML = '<span class="loading loading-spinner"></span> DÃ¼ÅŸÃ¼nÃ¼yor...';
        }
        
        // Duyguyu dÃ¼ÅŸÃ¼nme olarak ayarla
        emotion = 'thinking';
        isListening = false;
        updateAvatar();
        
        const response = await fetch('/assistant/ask/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value
            },
            body: JSON.stringify({ 
                question: questionText,
                use_elevenlabs: useElevenLabs,
                stream_audio: streamAudio
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            showNotification('Hata: ' + data.error, 'error');
            emotion = 'neutral';
            updateAvatar();
            return;
        }
        
        // CevabÄ± gÃ¶ster
        displayAnswer(data.answer);
        
        // Ses dosyasÄ± varsa oynat
        if (data.audio_url) {
            if (streamAudio) {
                // Ses akÄ±ÅŸÄ±
                playStreamingAudio(data.audio_url);
            } else {
                // Normal ses oynatma
                playAudio(data.audio_url);
            }
        } else {
            emotion = 'smiling';
            updateAvatar();
            setTimeout(() => {
                emotion = 'neutral';
                updateAvatar();
            }, 2000);
        }
        
        // Girdiyi temizle
        if (userInput) {
            userInput.value = '';
        }
        
    } catch (error) {
        console.error('Soru gÃ¶nderme hatasÄ±:', error);
        showNotification('Hata: ' + error.message, 'error');
        emotion = 'neutral';
        updateAvatar();
    } finally {
        // Butonu sÄ±fÄ±rla
        const sendButton = document.getElementById('sendButton');
        if (sendButton) {
            sendButton.disabled = false;
            sendButton.innerHTML = '<span class="mr-2">ðŸ“¤</span> GÃ¶nder';
        }
    }
}

// MesajÄ± sohbete ekle
function addChatMessage(message, sender) {
    const chatContainer = document.getElementById('chatContainer');
    if (!chatContainer) return;
    
    const messageElement = document.createElement('div');
    messageElement.className = `chat ${sender === 'user' ? 'chat-end' : 'chat-start'} mb-4`;
    messageElement.innerHTML = `
        <div class="chat-image avatar">
            <div class="w-10 rounded-full ${sender === 'user' ? 'bg-blue-500' : 'bg-purple-500'} flex items-center justify-center text-white">
                ${sender === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–'}
            </div>
        </div>
        <div class="chat-header mb-1">
            ${sender === 'user' ? 'Siz' : 'Asistan'}
            <time class="text-xs opacity-50 ml-2">${new Date().toLocaleTimeString()}</time>
        </div>
        <div class="chat-bubble ${sender === 'user' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}">${message}</div>
    `;
    
    chatContainer.appendChild(messageElement);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// CevabÄ± sohbette gÃ¶ster
function displayAnswer(answer) {
    addChatMessage(answer, 'assistant');
}

// Ses dosyasÄ±nÄ± oynat (akÄ±ÅŸ)
function playStreamingAudio(audioUrl) {
    isSpeaking = true;
    emotion = 'speaking';
    updateAvatar();
    
    // HalihazÄ±rda oynatÄ±lan sesi durdur
    if (currentAudio) {
        currentAudio.pause();
    }
    
    // Yeni ses elementi oluÅŸtur
    currentAudio = new Audio(audioUrl);
    
    currentAudio.onended = function() {
        console.log('AkÄ±ÅŸ sesi oynatma tamamlandÄ±');
        isSpeaking = false;
        emotion = 'smiling';
        updateAvatar();
        
        // Belirli bir sÃ¼re sonra nÃ¶tr duruma dÃ¶n
        setTimeout(() => {
            if (!isSpeaking && !isListening) {
                emotion = 'neutral';
                updateAvatar();
            }
        }, 2000);
    };
    
    currentAudio.onerror = function(e) {
        console.error('AkÄ±ÅŸ sesi hatasÄ±:', e);
        isSpeaking = false;
        emotion = 'neutral';
        updateAvatar();
        showNotification('Ses oynatma hatasÄ±', 'error');
    };
    
    currentAudio.play().catch(e => {
        console.error('AkÄ±ÅŸ sesi oynatma hatasÄ±:', e);
        isSpeaking = false;
        emotion = 'neutral';
        updateAvatar();
    });
}

// Ses dosyasÄ±nÄ± oynat (normal)
function playAudio(audioUrl) {
    isSpeaking = true;
    emotion = 'speaking';
    updateAvatar();
    
    const sound = new Howl({
        src: [audioUrl],
        autoplay: true,
        onend: function() {
            console.log('Ses oynatma tamamlandÄ±');
            isSpeaking = false;
            emotion = 'smiling';
            updateAvatar();
            
            // Belirli bir sÃ¼re sonra nÃ¶tr duruma dÃ¶n
            setTimeout(() => {
                if (!isSpeaking && !isListening) {
                    emotion = 'neutral';
                    updateAvatar();
                }
            }, 2000);
        }
    });
    
    sound.play();
}

// Metni seslendir (Web Speech API yedek)
function speakText(text) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'tr-TR';
        utterance.rate = 1;
        utterance.pitch = 1;
        
        utterance.onstart = function() {
            isSpeaking = true;
            emotion = 'speaking';
            updateAvatar();
        };
        
        utterance.onend = function() {
            isSpeaking = false;
            emotion = 'smiling';
            updateAvatar();
            
            // Belirli bir sÃ¼re sonra nÃ¶tr duruma dÃ¶n
            setTimeout(() => {
                if (!isSpeaking && !isListening) {
                    emotion = 'neutral';
                    updateAvatar();
                }
            }, 2000);
        };
        
        speechSynthesis.speak(utterance);
    }
}

// Bildirim gÃ¶ster
function showNotification(message, type = 'info') {
    const notificationContainer = document.getElementById('notificationContainer');
    if (!notificationContainer) return;
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} shadow-lg mb-4`;
    notification.innerHTML = `
        <div>
            <span>${message}</span>
        </div>
    `;
    
    notificationContainer.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Enter tuÅŸu ile mesaj gÃ¶nder
document.addEventListener('DOMContentLoaded', function() {
    const userInput = document.getElementById('userInput');
    if (userInput) {
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendQuestion();
            }
        });
    }
});
</script>

<style>
@keyframes mouth-move {
    0% { height: 20px; }
    50% { height: 35px; }
    100% { height: 20px; }
}

@keyframes eye-blink {
    0% { height: 20px; }
    50% { height: 5px; }
    100% { height: 20px; }
}

.mouth-speaking {
    animation: mouth-move 0.5s infinite;
}

.eye-blinking {
    animation: eye-blink 2s infinite;
}

.mouth-neutral {
    height: 20px;
}

/* Eksik animasyon sÄ±nÄ±flarÄ±nÄ± ekle */
.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: .5;
    }
}

.animate-bounce {
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% {
        transform: translateY(-25%);
        animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
    }
    50% {
        transform: translateY(0);
        animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
    <div class="max-w-4xl mx-auto">
        <div class="card bg-white shadow-xl rounded-2xl overflow-hidden">
            <!-- BaÅŸlÄ±k -->
            <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold">AI Asistan</h1>
                        <p class="opacity-90">Size bugÃ¼n nasÄ±l yardÄ±mcÄ± olabilirim?</p>
                    </div>
                    <div class="avatar">
                        <div class="w-16 rounded-full bg-white/20 flex items-center justify-center">
                            <span class="text-2xl">ðŸ¤–</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Avatar BÃ¶lÃ¼mÃ¼ -->
            <div class="p-6 bg-gradient-to-r from-indigo-50 to-purple-50 flex flex-col items-center">
                <div class="relative">
                    <!-- Avatar Konteyneri -->
                    <div id="assistantAvatar" class="avatar-placeholder w-48 h-48 rounded-full bg-gradient-to-br from-purple-400 to-indigo-600 flex items-center justify-center shadow-lg">
                        <!-- YÃ¼z elementleri -->
                        <div class="relative w-full h-full flex items-center justify-center">
                            <!-- GÃ¶zler -->
                            <div class="absolute top-12 left-10 w-6 h-6 bg-black rounded-full" id="leftEye"></div>
                            <div class="absolute top-12 right-10 w-6 h-6 bg-black rounded-full" id="rightEye"></div>
                            
                            <!-- AÄŸÄ±z -->
                            <div class="absolute bottom-12 w-16 bg-black rounded-full mouth-neutral" id="mouth"></div>
                            
                            <!-- Duygu gÃ¶stergesi -->
                            <div class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center" id="emotionIndicator"></div>
                        </div>
                    </div>
                    
                    <!-- Mikrofon GÃ¶stergesi -->
                    <div class="absolute -bottom-2 -right-2 w-12 h-12 bg-red-500 rounded-full flex items-center justify-center text-white shadow-lg animate-pulse hidden" id="micIndicator">
                        <span class="text-xl">ðŸŽ¤</span>
                    </div>
                </div>
                
                <div class="mt-4 text-center">
                    <h2 class="text-xl font-semibold text-gray-800">AI Asistan</h2>
                    <p class="text-gray-600">Verileriniz hakkÄ±nda her ÅŸeyi sorabilirsiniz</p>
                </div>
            </div>
            
            <!-- Chat Container -->
            <div class="p-6">
                <div id="chatContainer" class="space-y-4 h-96 overflow-y-auto mb-6 bg-gray-50 rounded-xl p-4">
                    <!-- Welcome message -->
                    <div class="chat chat-start">
                        <div class="chat-image avatar">
                            <div class="w-10 rounded-full bg-purple-500 flex items-center justify-center text-white">
                                ðŸ¤–
                            </div>
                        </div>
                        <div class="chat-header mb-1">
                            Asistan
                            <time class="text-xs opacity-50 ml-2">{{ request.user.first_name|default:request.user.username }}</time>
                        </div>
                        <div class="chat-bubble bg-purple-100 text-purple-800">
                            Merhaba {{ request.user.first_name|default:request.user.username }}! Size nasÄ±l yardÄ±mcÄ± olabilirim? ðŸ˜Š<br><br>
                            <strong>ðŸ’¡ Not:</strong> AI asistanÄ± kullanabilmek iÃ§in OpenAI API anahtarÄ±nÄ±n yapÄ±landÄ±rÄ±lmasÄ± gerekir.<br>
                            Sistem yÃ¶neticinizden API anahtarÄ±nÄ± yapÄ±landÄ±rmasÄ±nÄ± isteyin.
                        </div>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="flex gap-2 flex-wrap">
                    <div class="flex-1 relative min-w-[200px]">
                        <input 
                            type="text" 
                            id="userInput"
                            placeholder="Sorunuzu buraya yazÄ±n veya sesli komut verin..."
                            class="input input-bordered w-full pr-12"
                        />
                        <button 
                            id="micButton"
                            onclick="toggleMicrophone()"
                            class="btn btn-circle btn-primary absolute right-2 top-1/2 transform -translate-y-1/2 bg-blue-500 hover:bg-blue-600 border-none"
                        >
                            <span id="micIcon" class="text-lg">mic</span>
                        </button>
                    </div>
                    <button 
                        id="ttsButton"
                        onclick="toggleTTS()"
                        class="btn btn-secondary"
                    >
                        <span class="mr-2">ðŸŽ¤</span> ElevenLabs
                    </button>
                    <button 
                        id="streamingButton"
                        onclick="toggleStreaming()"
                        class="btn btn-info"
                    >
                        <span class="mr-2">ðŸ“¡</span> AkÄ±ÅŸ KAPALI
                    </button>
                    <button 
                        id="sendButton"
                        onclick="sendQuestion()"
                        class="btn btn-primary"
                    >
                        <span class="mr-2">ðŸ“¤</span> GÃ¶nder
                    </button>
                </div>
                
                <!-- Notification Container -->
                <div id="notificationContainer" class="mt-4"></div>
                
                <!-- API Key Setup Instructions -->
                <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-bold text-yellow-800 mb-2">ðŸ’¡ AI AsistanÄ± EtkinleÅŸtirme</h3>
                    <p class="text-yellow-700 text-sm">
                        AI asistanÄ± kullanabilmek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin:
                    </p>
                    <ol class="list-decimal list-inside text-yellow-700 text-sm mt-2 space-y-1">
                        <li><a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline">OpenAI</a> veya <a href="https://elevenlabs.io/" target="_blank" class="text-blue-600 hover:underline">ElevenLabs</a> hesabÄ±nÄ±zdan API anahtarlarÄ±nÄ± alÄ±n</li>
                        <li>Proje dizinindeki <code>.env</code> dosyasÄ±nÄ± dÃ¼zenleyin</li>
                        <li><code>OPENAI_API_KEY=sk-...</code> ve/veya <code>ELEVENLABS_API_KEY=...</code> satÄ±rlarÄ±nÄ± ekleyin</li>
                        <li>Sunucuyu yeniden baÅŸlatÄ±n</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}